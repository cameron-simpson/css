#!/bin/sh
#
# Read a mail folder with mutt.
#	- Cameron Simpson <cs@zip.com.au>
#

cmd=$0
usage="Usage: $0 [+a] [+s] [+t] [-f] [some-mutt-options...] [mutt-folder]"

mfolder=+attn
muttopts=
anyhost=
use_term=1
use_screen=

badopts=
while :
do
  case $1 in
    +a)		termopts="$termopts $1" ;;
    -s)		use_screen=1 ;;
    +s)		use_screen= ;;
    +t)		use_term= ;;
    -f)		anyhost=1 ;;
    -[nR])	muttopts="$muttopts $1" ;;
    -[em])	muttopts="$muttopts $1 "`shqstr "$2"`; shift ;;
    --)		shift; break ;;
    -?*|+?*)	echo "$cmd: unrecognised option: $1" >&2; badopts=1 ;;
    *)		break ;;
  esac
  shift
done

if [ $# -gt 0 ]
then
  case $1 in
    /*)		mfolder=$1 ;;
    +*)		mfolder=$1 ;;
    imap:*)	mfolder=$1 anyhost=1 ;;
    *.*)	mfolder=nntp://$NNTPSERVER/$1 anyhost=1 ;;
    *)		mfolder=+$1 ;;
  esac
  shift
  [ $# = 0 ] || { echo "$cmd: extra arguments: $*" >&2; badopts=1; }
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

[ $anyhost ] || needhost "$HOMEHOST@$SYSTEMID" || exit 1

fpath=`mailfolderpath "$mfolder"` || exit 1
if [ -z "$fpath" ]
then
    DELETE_FOLDER=
    SAVE_FOLDER=+SAVED/misc
    mhdir "$MAILDIR/SAVED/misc"
else
    fbase=`basename "$fpath"` || exit 1
    DELETE_FOLDER=+DELETED/$fbase
    SAVE_FOLDER=+SAVED/$fbase
    if ismhdir "$fpath"
    then
	mhdir "$MAILDIR/DELETED/$fbase" "$MAILDIR/SAVED/$fbase"
    else
	maildir "$MAILDIR/DELETED/$fbase" "$MAILDIR/SAVED/$fbase"
    fi
fi
export DELETE_FOLDER SAVE_FOLDER

cd || exit 1
for shfile in muttsh muttsh.$mfolder
do
  [ -s "$HOME/rc/mail/$shfile" ] && . "$HOME/rc/mail/$shfile"
done

export mfolder
## -e \"fcc-hook \$mfolder \$mfolder\"
set sh -c "set -x; exec mutt -f \"\$mfolder\" -e \"fcc-hook . \$mfolder\" $muttopts"

[ $use_screen ] && set scr "mutt_$mfolder" "$@"
[ $use_term   ] && set term $termopts -n "mutt $mfolder" "$@"

set -x
exec "$@"
