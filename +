#!/bin/sh -u
#
# Read a mail folder with mutt.
#	- Cameron Simpson <cs@zip.com.au>
#

: ${MAILHOMEHOST:=$HOMEHOST}

cmd=$0
usage="Usage: $0 [+a] [+s] [+t] [-f] [some-mutt-options...] [mutt-folder]"

# hack to clear my alert window when I view my default folder
( [ $# = 0 ] && alert "`clear`" ) &

mfolder=+me
muttopts=
anyhost=
use_term=1
use_screen=
preshcmd=
postshcmd=
termopts=

badopts=
while [ $# -gt 0 ]
do
  case $1 in
    +a)		termopts="$termopts $1" ;;
    -s)		use_screen=1 ;;
    +s)		use_screen= ;;
    +t)		use_term= ;;
    -f)		anyhost=1 ;;
    -[nR])	muttopts="$muttopts $1" ;;
    -[em])	muttopts="$muttopts $1 "`shqstr "$2"`; shift ;;
    --pre=*)	preshcmd=`expr "x$1" : 'x--pre=\(.*\)'` ;;
    --post=*)	postshcmd=`expr "x$1" : 'x--post=\(.*\)'` ;;
    --)		shift; break ;;
    -?*|+?*)	echo "$cmd: unrecognised option: $1" >&2; badopts=1 ;;
    *)		break ;;
  esac
  shift
done

if [ $# -gt 0 ]
then
  case $1 in
    /*)		mfolder=$1 ;;
    +*)		mfolder=$1 ;;
    imap:*)	mfolder=$1 anyhost=1 ;;
    *.*)	mfolder=nntp://$NNTPSERVER/$1 anyhost=1 ;;
    *)		mfolder=+$1 ;;
  esac
  shift
  [ $# = 0 ] || { echo "$cmd: extra arguments: $*" >&2; badopts=1; }
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

[ $anyhost ] || needhost "$HOMEHOST@$SYSTEMID" || exit 1

fpath=`mailfolderpath "$mfolder"` || exit 1

# where to taqke copies - presumes sendmail=sendmesg-fcc in muttrc
SENDMESG_FCC="$fpath +spool-out"
export SENDMESG_FCC

if [ -z "$fpath" ]
then
    DELETE_FOLDER=
    SAVE_FOLDER=+SAVED/misc
    maildir "$MAILDIR/SAVED/misc"
else
    [ -d "$fpath/." ] || \
    { echo "$cmd: $fpath: not a directory" >&2
      exit 1
    }

    ismaildir "$fpath" || ismhdir "$fpath" \
    || { echo "$cmd: $fpath: not Maildir or MH folder" >&2
	 exit 1
       }
    fbase=`basename "$fpath"` || exit 1
    DELETE_FOLDER=+DELETED/$fbase
    SAVE_FOLDER=+SAVED/$fbase
    if ismaildir "$fpath"
    then maildir "$MAILDIR/DELETED/$fbase" "$MAILDIR/SAVED/$fbase"
    else mhdir "$MAILDIR/DELETED/$fbase" "$MAILDIR/SAVED/$fbase"
    fi
fi
export DELETE_FOLDER SAVE_FOLDER

cd || exit 1
for shfile in muttsh muttsh.$mfolder
do
  [ -s "$HOME/rc/mail/$shfile" ] && . "$HOME/rc/mail/$shfile"
done

##export mfolder
## -e \"fcc-hook \$mfolder \$mfolder\"
muttcmd="mutt -f '$mfolder' -e 'fcc-hook . $mfolder' $muttopts"
if [ -n "$fpath" ]
then
  ##muttcmd="$muttcmd -e 'set maildir_cache=$fpath/.mutt-hcache'"
  mutthcache=$HOME/var/mutt/header-cache
  needdir "$mutthcache" && muttcmd="$muttcmd -e 'set header_cache=$mutthcache'"
  [ -s "$fpath/.muttrc" ] && muttcmd="$muttcmd -e 'source $fpath/.muttrc'"
fi
set sh -c "exec $muttcmd"

[ $use_screen ] && set scr "mutt_$mfolder" "$@"
[ $use_term   ] && set term -j email $termopts -n "mutt $mfolder" "$@"

set -x
[ -z "$preshcmd" -a -z "$postshcmd" ] && exec "$@"

if eval "$preshcmd"
then
  "$@"
  xit=$?
  ( cd $HOME/rc/mail && myke ) || xit=1
  eval "$postshcmd" || xit=1
  exit $xit
fi
