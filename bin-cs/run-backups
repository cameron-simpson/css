#!/bin/sh
#
# Run my backups from the current machine to other places.
# Consults ~/rc-local/rsync.* files for image backups
# and ~/rc-local/histbackup.* for rhistbackup backups.
# - Cameron Simpson <cs@cskk.id.au> 25jul2020
#

set -ue

rsopts=
[ -t 2 ] && rsopts=-P

rcdir=$HOME/rc-local

xit=0

for rsyncf in "$rcdir"/rsync.*
do
  base=$( basename "$rsyncf" )
  target=${base#*.}
  ( cd
    pfx "$target" set-x rsync --files-from=- -iar --delete $rsopts . "$target:BACKUP/$HOST/rsync/"
  ) < "$rsyncf" || xit=1
done

for hbf in "$rcdir"/histbackup.*
do
  base=$( basename "$hbf" )
  target=${base#*.}
  while read -r src dst
  do
    : ${dst:=$(basename "$src")}
    ( cd
      pfx "$target" set-x rhistbackup "$src:$target:BACKUP/$HOST/histbackup/$dst"
    ) </dev/null || xit=1
  done <"$hbf"
done

exit $xit
