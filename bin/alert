#!/bin/sh
#
# Write a possibly-colourised string to the alert log.
#	- Cameron Simpson <cs@zip.com.au>
#

set -ue

: ${OS:=`uname -s | tr '[A-Z]' '[a-z]'`}
: ${LOGDIR:=$HOME/var/log}
: ${ALERTLOG:=$LOGDIR/alert-local}

cmd=$0
usage="Usage: $cmd [-c colour] [-G] {-|echo-args...]}"

colour=
growl=
case "$OS" in
  darwin)       growl=1 ;;
esac

badopts=

while [ $# -gt 0 ]
do
  case $1 in
    -c) colour=$2; shift ;;
    -G) growl=1 ;;
    +G) growl= ;;
    --) shift; break ;;
    -?*)echo "$cmd: unrecognised option: $1" >&2
        badopts=1
        ;;
    *)  break ;;
  esac
  shift
done

if [ $# = 0 ]
then
  echo "$cmd: missing \"-\" or echo-args" >&2
  badopts=1
else
  case "$*" in
    -)  set -- "`cat`" ;;
  esac
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

xit=0

exec >>"$ALERTLOG"

if [ -n "$colour" ]
then  colour_echo "$colour" "$*"
else  echo "$*"
fi || xit=1

if [ $growl ]
then
  growlnotify -m "$*" || xit=1
fi

exit $xit
