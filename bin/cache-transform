#!/bin/sh
#
# Return the transform of some input data, keeping a cache.
#       - Cameron Simpson <cs@zip.com.au> 22oct2011
#

set -ue

: ${TMPDIR:=/tmp}
: ${CACHEDIR=$HOME/var/cache/transforms}

cmd=$0
usage="Usage: $cmd cachedir command [args...]"

badopts=

if [ $# = 0 ]
then
  echo "$cmd: missing cachedir" >&2
  badopts=1
else
  cachedir=$1
  shift
  case "$cachedir" in
    /* | ./* | ../* )
        ;;
    *)  cachedir=$CACHEDIR/$cachedir
        ;;
  esac
fi

if [ $# = 0 ]
then
  echo "$cmd: missing command" >&2
  badopts=1
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

[ -d "$cachedir/." ] || ( set -x; exec mkdir -p "$cachedir" )

tmppfx=$cachedir/.tmp.$$
input=$tmppfx.input
output=$tmppfx.output
trap 'rm -f -- "$input" "$output"' 0 1 3 15

# save the input and compute its SHA1 hash
cat >"$input" || exit $?
sha1=`sha1sum - <"$input" | sed 's/ .*//'`
[ -n "$sha1" ] || exit 1
cachefile=$cachedir/$sha1

if [ -s "$cachefile" ]
then
  cat "$cachefile"
else
  if "$@" <"$input" >"$output"
  then
    mv "$output" "$cachefile"
    cat "$cachefile"
  else
    xit=$?
    cat "$output"       # user should still see the output
  fi
fi
