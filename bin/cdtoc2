#!/usr/bin/env python3
#
# Extract discid and track info from a CD as a preliminary to
# constructing a FreeDB CDDB entry. Used by cdsubmit.
# Rework of cddiscinfo in Python, since the Perl libraries aren't
# working any more; update to work on OSX and use MusicBrainz.
#	- Cameron Simpson <cs@zip.com.au> 31mar2016
#

from __future__ import print_function
import os
from os.path import basename
import sys
import discid
import musicbrainzngs

USAGE = 'Usage: %s [device]'
APP_VERSION = '2.0a'

def main(argv):
  cmd = basename(argv.pop(0))
  usage = USAGE % (cmd,)
  device = None
  if argv:
    device = argv.pop(0)
    if device == '' or device == 'default':
      device = None
  D = discid.read(device)
  X('musicbrainzngs.get_releases_by_discid(%r)...', D.id)
  musicbrainzngs.set_useragent(cmd, APP_VERSION, os.environ['EMAIL'])
  info = musicbrainzngs.get_releases_by_discid(D.id)
  cdstub = info['cdstub']
  print(cdstub['artist'])
  print(cdstub['title'])
  offset = 0
  for n, track in enumerate(cdstub['track-list'], 1):
    track_length = int(track['length'])
    print(n, track_length, offset)
    offset += track_length
    print(track['title'])
    print()

def X(msg, *a):
  if a:
    msg = msg % a
  print(msg, file=sys.stderr)

if __name__ == '__main__':
  sys.exit(main(sys.argv))
