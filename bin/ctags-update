#!/bin/sh
#
# Update the tags file from the specified files.
# Recite the chosen tags file to standard output.
#   - Cameron Simpson <cs@cskk.id.au>
#

set -ue

exec 3>&1 1>&2

tags=

cmd=$(basename "$0")
usage="Usage: $cmd [-o tagfile] [--] paths..."

badopts=

while [ $# -gt 0 ]
do
  case $1 in
    -o) tags=$2; shift ;;
    --) shift; break ;;
    -?*)echo "$cmd: unrecognised option: $1" >&2
        badopts=1
        ;;
    *)  break ;;
  esac
  shift
done

if [ $# = 0 ]
then
  echo "$cmd: missing filenames" >&2
  badopts=1
else
  first=1
  for filename
  do
    rfilename=$( realpath "$filename" ) || {
      echo "$cmd: unresolved filename: $filename" >&2
      badopts=1
      continue
    }
    if [ $first ]
    then
      set --
      first=
    fi
    if [ -d "$rfilename" ]
    then
      dirpath=$rfilename
      for rfile in $( find "$dirpath" -type f -size +0 -print )
      do
        set -- ${1+"$@"} "$rfile"
      done
    else
      dirpath=$( dirname "$rfilename" )
      [ -s "$rfilename" ] && set -- ${1+"$@"} "$rfilename"
    fi
    [ -n "$tags" ] \
    || tags=$( cd "$dirpath" && findup tags ) \
    || echo "$cmd: no tags found from $dirpath/" >&2
  done
  [ $# -gt 0 ] || {
    echo "$cmd: no filenames after scan" >&2
    badopts=1
  }
fi

[ -n "$tags" ] || {
  echo "$cmd: no tags file found" >&2
  badopts=1
}

[ $badopts ] && { echo "$usage" >&2; exit 2; }

echo "$tags" >&3
exec 3>&-

lock -P "$tags" ctags -o "$tags" --tag-relative --links=no "$@"
