#!/bin/sh
#
# Log an action to $LOGDIR/dlog-quick and also via buglog's dlog facility,
# which uses buglog-daily.      - Cameron Simpson <cs@cskk.id.au>
# 

set -ue

cmd=$0
usage="Usage: $cmd [-c cats] [-d datetime] [-l {log|logfile}] [--] [CATEGORIES:] [remark...]"

dlog_cats=
logname=dlog-quick
trace=  ##set-x
echo=:
[ -t 2 ] && echo=eecho

: ${LOGDIR:=$HOME/var/log}

when=${DLOG_WHEN:-}

[ -t 0 ] && exec </dev/null

if [ -n "${HOMEHOST:-}" ]
then
  if not flag DLOG_LOCAL && [ "x$HOST" != "x$HOMEHOST" ]
  then
    if flag DLOG_REMOTE_DISABLE
    then
      $echo "$cmd: flag DLOG_REMOTE_DISABLE: logging locally"
    else
      exec $trace sshx "$HOMEHOST" ./bin/with-login-env dlog ${1+"$@"}
    fi
  fi
fi

badopts=

while [ $# -gt 0 ]
do
  case $1 in
    -c) dlog_cats=$2; shift ;;
    -d) when=$2; shift ;;
    -l) logname=$2; shift ;;
    --) shift; break ;;
    -?*)echo "$cmd: unrecognised option: $1" >&2; badopts=1 ;;
    *)  break ;;
  esac
  shift
done

if [ $# = 0 ]
then
  read -r headline || {
    echo "$cmd: no headline on standard input" >&2
    exit 1
  }
else
  headline=$*
fi

if    dlog_cats2=`expr "x$headline" : 'x\([A-Z][A-Z_0-9,]*\):.*'`
then
  if [ -n "$dlog_cats" ]
  then
    echo "$cmd: -c \"$dlog_cats\" conflicts with headline categories \"$dlog_cats2\"" >&2
    badopts=1
  else
    dlog_cats=$dlog_cats2
    headline=` expr "x$headline" : 'x[A-Z][A-Z_0-9,]*: *\(.*\)'`
  fi
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

[ -n "$dlog_cats" ] || dlog_cats=`dlog-category` || {
  echo "$cmd: cannot infer logging categories, NOT LOGGING: $headline" >&2
  exit 1
}

case "$logname" in
  /*) ;;
  *) logname=$LOGDIR/$logname ;;
esac

# compute ISO8601 timestamp string
if [ -n "$when" ]
then  ts=`date -d "$when" '+%Y-%m-%d %H:%M:%S'`
else  ts=`date '+%Y-%m-%d %H:%M:%S'`
fi

echo "$ts $dlog_cats: $headline" >>"$logname"
exec buglog -c "$dlog_cats" -d "$ts" -B dlog "$headline"
