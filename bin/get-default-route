#!/bin/sh
#
# Probe "netstat -rn" for default route.
#   - Cameron Simpson <cs@zip.com.au> 02feb2015
#

set -ue

flagpfx=ROUTE_GW_

trace=
[ -t 2 ] && trace=set-x

# get gateway IPv4 addresses
gws=$( netstat -rn | awk '$1 == "default" || $1 == "0.0.0.0" { print $2 }' )

# generate set of flags that should be set
set -- $( set -x; for gwaddr in $gws; do echo "$gwaddr"; done | sed -n "y/./_/; s/^/$flagpfx/p" )

# reset existing true flags unless present in route flag list
for gwflag in $( flag -q | grep "^$flagpfx" )
do
  case " $* " in
    *\ $gwflag\ *) ;;
    *)  $trace flag "$gwflag" 0 ;;
  esac
done

for gwflag
do
  $trace flag "$gwflag" 1
done

for gwaddr in $gws
do  echo "$gwaddr"
done
