#!/bin/sh
#
# Put (fetch-from-remote-end) a local git ref to a remote work directory.
# Printed the resolved reference to stdout for use.
#   - Cameron Simpson <cs@zip.com.au> 14oct2016
# 

set -ue

: ${TMPDIR:=/tmp}

trace=
[ -t 2 ] && trace=set-x

cmd=$( basename "$0" )
usage="Usage: $cmd [-d git-work-dir] {/path|./path|../path|remote[:path]} [local-ref]
  -d git-work-dir   Git working directory (should contain a .git).
                    Default the git work directory containing the
                    current directory.
  local-ref         Changeset reference in the source git working directory.
                    Defaul;t: HEAD"

rev=HEAD

badopts=
git_work_dir=.

while [ $# -gt 0 ]
do
  case $1 in
    -d) git_work_dir=$2; shift ;;
    --) shift; break ;;
    -?*)echo "$cmd: unrecognised option: $1" >&2; badopts=1 ;;
    *)  break ;;
  esac
  shift
done

if [ $# = 0 ]
then
  echo "$cmd: missing remote" >&2
  badopts=1
else
  remote=$1
  shift
  case "$remote" in
    /* | ./* | ../* )
            remote_dir=$remote
            remote=
            ;;
    *:*)    remote_dir=$( expr "x$remote" : 'x[^:]*:\(.*\)' )
            remote=$(     expr "x$remote" : 'x\([^:]*\):.*' )
            ;;
    *)      remote_dir=
            ;;
  esac
fi

if [ $# -gt 0 ]
then
  rev=$1
  shift
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

git_top=$( git-top "$git_work_dir" )
git_top_repo=$git_top/.git
revhash=$( git "--git-dir=$git_top_repo" rev-parse "$rev" )

# local directory? run git directly
[ -n "$remote" ] || exec git -C "$remote_dir" fetch --verbose --progress "$git_top_repo" "$revhash"

# otherwise remote: work a lot harder
git_top_remote=git://127.0.0.1:1234$git_top

qremote_dir=$( shqstr "$remote_dir" )
qrevhash=$( shqstr "$revhash" )
qgit_top_remote=$( shqstr "$git_top_remote" )

gitd_out=$TMPDIR/$cmd.gitd-out.$$
gitd_in=$TMPDIR/$cmd.gitd-in.$$

git "--git-dir=$git_top_repo" init --shared=true
>>"$git_top_repo/git-daemon-export-ok"

# prepare some pipes to connect local git with ssh to remote
mkfifo -m 600 "$gitd_in" "$gitd_out"
exec 3<>"$gitd_in" 4<>"$gitd_out"
rm -f "$gitd_in" "$gitd_out"

# start local git daemon
$trace git -C "$git_top" daemon --inetd --verbose --informative-errors "$git_top" <&3 >&4 &
gitd=$!

# present the git daemon to the remote host
$trace ssh "$remote" '
    set -ue'"
    remote_dir=$qremote_dir"'
    [ -z "$remote_dir" ] || cd "$remote_dir"
    nc -l 127.0.0.1 1234
    ' <&4 >&3 &
ssh_gitd=$!

# detach from pipes
exec 3<&- 4<&-

xit=0

# go to the remote host and access the local git via the daemon
$trace ssh "$remote" '
    set -ue'"
    remote_dir=$qremote_dir
    revhash=$qrevhash
    git_top_remote=$qgit_top_remote"'
    cd "$remote_dir"; pwd
    git fetch --verbose --progress "$git_top_remote" "$revhash"' \
|| xit=1

kill "$gitd" || xit=1

exit $xit
