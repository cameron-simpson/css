#!/bin/sh
#
# Grep all lines from stdin containing all the command line regexps.
#	- Cameron Simpson <cs@zip.com.au> 12nov2001
#

set -ue

cmd=$0
usage="Usage: $cmd [-i] [-o] sed-regexps...
	-i	Ignore case.
	-o	OR words instead of AND."

any=
icase=
header=
trace=

badopts=
while [ $# -gt 0 ]
do
  case $1 in
    -H) header=1 ;;
    -i)	icase=1 ;;
    -o)	any=1 ;;
    -x) trace=set-x ;;
    --)	shift; break ;;
    -?*)echo "$cmd: unrecognised option: $1" >&2; badopts=1 ;;
    *)	break ;;
  esac
  shift
done

if [ $# = 0 ]
then
    echo "$cmd: missing sed-regexps" >&2
    badopts=1
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

ok=1

first=1
for word
do
  [ $first ] && set --

  case "$word" in
    */*)  word=`echo "$word" | sed 's;/;\\\\/;g'`
  esac
  case "$word" in
    !*)   word=`expr "x$word" : 'x.\(.*\)'`
	  set -- -e "/$word/d" ${1+"$@"}
	  ;;
    *)    if [ $any ]
	  then set -- ${1+"$@"} -e "/$word/b ok"
	  else set -- ${1+"$@"} -e "/$word/!d"
	  fi
	  ;;
  esac

  first=
done

[ $ok ] || exit 1

[ $icase ] && set -- -e h -e 'y/ABCDEFGHIJKLMNOPQRSTUVWXYZ/abcdefghijklmnopqrstuvwxyz/' ${1+"$@"}
[ $any ] && set -- ${1+"$@"} -e d -e ':ok'
[ $icase ] && set -- ${1+"$@"} -e g
[ $header ] && set -- -e '1{p;d;}' ${1+"$@"}

exec $trace sed "$@"
