#!/bin/sh
#
# Patch /etc/hosts (by default) with raw /etc/hosts content from another file.
# I use this to wire certain special addresses into my /etc/hosts files such
# as IP addresses of specific machines on known local LANs.
#   - Cameron Simpson <cs@cskk.id.au> 15apr2016
#

set -ue

hosts=/etc/hosts
sfx=.l

cmd=$0
usage="Usage: $cmd [hostsfile] <etc-hosts-content"

badopts=

if [ $# -gt 0 ]
then
  hosts=$1
  shift
fi

[ -s "$hosts" ] || { echo "$cmd: expected nonempty regular file: $hosts" >&2
                     badopts=1
                   }

if [ $# -gt 0 ]
then
  echo "$cmd: extra arguments: $*" >&2
  badopts=1
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

# make sure marker lines are present
grep '^## BEGIN KNOWN ADDRESSES' "$hosts" >/dev/null \
|| { echo; echo '## BEGIN KNOWN ADDRESSES'; echo '## END KNOWN ADDRESSES'; } \
   >>"$hosts"

exec rlr -f '^## BEGIN KNOWN ADDRESSES' -t '^## END KNOWN ADDRESSES' "$hosts"
