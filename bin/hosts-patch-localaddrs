#!/bin/sh
#
# Patch /etc/hosts (by default) with 127.0.0.n addresses with names from standard input.
#   - Cameron Simpson <cs@cskk.id.au> 10apr2016
#

set -ue

hosts=/etc/hosts
sfx=.l

cmd=$0
usage="Usage: $cmd [hostsfile] <hosts"

badopts=

if [ $# -gt 0 ]
then
  hosts=$1
  shift
fi

[ -s "$hosts" ] || { echo "$cmd: expected nonempty regular file: $hosts" >&2
                     badopts=1
                   }

if [ $# -gt 0 ]
then
  echo "$cmd: extra arguments: $*" >&2
  badopts=1
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

# make sure marker lines are present
grep '^## BEGIN LOCAL ADDRESSES' "$hosts" >/dev/null \
|| { echo; echo '## BEGIN LOCAL ADDRESSES'; echo '## END LOCAL ADDRESSES'; } \
   >>"$hosts"

n=2
while read names
do
  case "$names" in
    '' | \#* )
      echo "$names"
      continue
      ;;
  esac
  printf "127.0.0.%d" "$n"
  n=$(expr $n + 1)
  for name in $names
  do  printf " $name$sfx"
  done
  echo
done \
| rlr -f '^## BEGIN LOCAL ADDRESSES' -t '^## END LOCAL ADDRESSES' "$hosts"
