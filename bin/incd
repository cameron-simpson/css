#!/bin/sh
#
# Run command in another directory, possibly on another host.
# - Cameron Simpson <cs@cskk.id.au> 05mar2003
#

cmd=$0
usage="Usage: $cmd [[user@]host:]dir [command [args...]]"

mayuseparent=
hostpart=
sshopts=

badopts=

if [ $# = 0 ]
then
  echo "$cmd: missing dir" >&2
  badopts=1
else
  dir=$1; shift
  if hostpart=$( expr "x$dir" : 'x\([a-z][a-z0-9_@]*[a-z]\):.*' )
  then
    dir=$(       expr "x$dir" : 'x[a-z][a-z0-9_@]*[a-z]:\(.*\)' )
    if [ $# = 0 ]
    then
      sshopts=-t
      qcmd='${SHELL:-/bin/sh} --login'
    else
      qcmd=$( shqstr "$@" )
    fi
  else
    if [ $# = 0 ]
    then
      echo "$cmd: missing command" >&2
      badopts=1
    fi
  fi
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

if [ ! -d "$dir/." ] && [ $mayuseparent ]
then
    parent=`dirname "$dir"`
    [ -d "$parent/." ] && dir=$parent
fi

if [ -n "$hostpart" ]
then
  qdir=$( shqstr "$dir" )
  [ -t 2 ] && set -x
  exec ssh $sshopts "$hostpart" "cd $qdir; exec $qcmd"
else
  cd "$dir" || exit 1
  ##[ -t 2 ] && set -x
  exec "$@"
fi
