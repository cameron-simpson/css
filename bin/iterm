#!/bin/sh
#
# Convenience wrapper for iTerm2 opterations.
#       - Cameron Simpson <cs@cskk.id.au> 26apr2014
#

set -ue

trace=

cmd=$0
usage="Usage: $cmd [-x] op [op-args...]
  Ops:
    badge-forma format...
    open command [args...]
        Open new terminal window runnong command.
    setvar varname value...
    switch-profile profile name...
        Change the current tty's profile to 'profile name...'"

badopts=

while [ $# -gt 0 ]
do
  case $1 in
    -x) trace=set-x ;;
    --) shift; break ;;
    -?) echo "$cmd: unrecognised option: $1" >&2
        badopts=1
        ;;
    *)  break ;;
  esac
  shift
done

if [ $# = 0 ]
then
  echo "$cmd: missing op" >&2
  badopts=1
else
  op=$1
  shift
  case $op in
    badge-format)
      if [ $# = 0 ]
      then
        echo "$cmd: $op: missing format" >&2
        badopts=1
      fi
      ;;
    colour)
      if [ $# = 0 ]
      then
        echo "$cmd: $op: missing scheme" >&2
        badopts=1
      else
        scheme=$1
        shift
        case "$scheme" in
          green)    fg=0,65535,0 bg=0,0,0 ;;
          white)    fg=65535,65535,65535 bg=0,0,0 ;;
          black)    fg=0,0,0 bg=65535,65535,65535 ;;
          *)        echo "$cmd: $op: unsupported colour scheme: $scheme" >&2
                    badopts=1
                    ;;
        esac
      fi
      [ $badopts ] || {
        tee /dev/tty <<X | osascript -
          tell application iTerm2
            -- tell current session
              -- set foreground color to {$fg, 0}
              -- set background color to {$bg, 0}
            -- end tell
          end tell
X
      }
      ;;
    open)
      if [ $# = 0 ]
      then
        echo "$cmd: $op: missing command" >&2
        badopts=1
      fi
      ;;
    setvar)
      if [ $# -lt 1 ]
      then
        echo "$cmd: $op: missing varname" >&2
        badopts=1
      fi
      if [ $# -lt 2 ]
      then
        echo "$cmd: $op: missing value" >&2
        badopts=1
      fi
      ;;
    switch-profile)
      if [ $# = 0 ]
      then
        echo "$cmd: $op: missing profile name" >&2
        badopts=1
      fi
      ;;
    *)echo "$cmd: unrecognised op: $op" >&2
      badopts=1
      ;;
  esac
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

case "$op" in
  badge-format)
    format64=$( printf '%s' "$*" | base64 )
    printf '\e]1337;SetBadgeFormat=%s\a' "$format64"
    ;;
  open)
    shcmd=$( shqstr "$@" )
    as_shcmd=\"$( printf '%s\n' "$shcmd" | sed 's/["\\]/\\&/g' )\"
    set -- `ttysize` || :
    columns=${1:-80}
    rows=${2:-65}
    iterm_script="
        tell application \"iTerm\"
            activate
            set newterm to (make new terminal)
            tell newterm
                set number of columns to $columns
                set number of rows to $rows
                set newsession to (make new session at the end of sessions)
                tell newsession
                    exec command $as_shcmd
                end tell
            end tell
        end tell"
    exec $trace osascript -e "$iterm_script"
    ;;

  setvar)
    varname=$1
    shift
    value64=$( printf '%s' "$*" | base64 )
    printf '\e]1337;SetUserVar=%s\a' "$value64"
    ;;

  switch-profile)
    profilename=$*
    printf '\e]50;SetProfile=%s\a' "$profilename" >/dev/tty
    ;;

  *)echo "$cmd: $op: unimplemented op" >&2
    exit 2
    ;;
esac
