#!/bin/sh
#
# Convert a local mailbox into an mbox mailbox.
#       - Cameron Simpson <cs@zip.com.au> 24feb2013
#

set -ue

cmd=`basename "$0"`
usage="Usage: $cmd mailbox"

badopts=

if [ $# = 0 ]
then
  echo "$cmd: missing mailbox" >&2
  badopts=1
else
  mailbox=$1
  shift
  case "$mailbox" in
    /*) ;; *) mailbox=`pwd`/$mailbox ;;
  esac
  if [ ! -e "$mailbox" ]

  then
    echo "$cmd: missing mailbox: $mailbox" >&2
    badopts=1
  fi
fi

if [ $# -gt 0 ]
then
  echo "$cmd: extra arguments: $*" >&2
  badopts=1
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

mailboxtmp=$mailbox.tmp$$
mailboxold=$mailbox.old$$

set -x

# empty maildir: remove and exit
ismaildir "$mailbox" && rm0maildir "$mailbox" && [ ! -d "$mailbox" ] && exit 0

# already an mbox? exit
ismbox "$mailbox" && exit 0

# make stub mbox
>>"$mailboxtmp"

if if ismaildir "$mailbox"
   then maildir-cat "$mailbox" >"$mailboxtmp"
   else mutt -n -F /dev/null -f "$mailbox" -e "set sort=mailbox-order; set confirmappend=no; set delete=yes; push '<tag-pattern>.<enter><tag-prefix><save-message>$mailboxtmp<enter><sync-mailbox><exit>'"
   fi
then
  mv "$mailbox" "$mailboxold"
  mv "$mailboxtmp" "$mailbox"
  if ismaildir "$mailboxold"
  then
    rm -r "$mailboxold"
  else
    rmdir "$mailboxold"
  fi
else
  rm -f "$mailboxtmp"
fi
