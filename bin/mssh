#!/bin/sh
#
# Run the same command on multiple hosts.
#       - Cameron Simpson <cs@zip.com.au> 22nov2012
# 

set -ue

cmd=$0
usage="Usage: $cmd [--no-hostpfx] [-e ssh] [ssh-options...] hostlist command [args...]"

badopts=

sshargs=
dohostpfx=1
while [ $# -gt 0 ]
do
  case $1 in
    --no-hostpfx)
        dohostpfx=
        ;;
    -[aAgknNqsTxXYC1246])
        sshargs="$sshargs "`shqstr "$1"`
        ;;
    -[bceImpLRD])
        sshargs="$sshargs "`shqstr "$1" "$2"`
        ;;
    --) shift; break ;;
    -?*)echo "$cmd: unrecognised option: $1" >&2
        badopts=1
        ;;
    *)  break ;;
  esac
done

if [ $# = 0 ]
then
  echo "$cmd: missing hostlist" >&2
  badopts=1
else
  hostlist=$1
  shift
fi

if [ $# = 0 ]
then
  echo "$cmd: missing command" >&2
  badopts=1
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

exec </dev/null

for host in `hostlist "$hostlist"`
do
  ( sshargs="$sshargs "`shqstr "$host" "$@"`
    eval "set -- ssh -n $sshargs"
    [ $dohostpfx ] && set -- pfx "$host" "$@"
    exec "$@"
  ) &
done

wait
