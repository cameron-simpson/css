#!/bin/sh -u
#
# Spawn a mutt to edit a message and dispatch a reply in tmux or screen.
# This lets you detach from an unfinished reply and finish it later.
# My muttrc has this:
#
#  macro index g ":set editor=muttedit<enter><group-reply>:set editor=$EDITOR<enter>" "group reply"
#   
# - Cameron Simpson <cs@cskk.id.au> 31mar2006
# 

set -ue

cmd=$0
usage="Usage:
  $cmd [-d] filename    Start a new message in mutt based on filename.
    -d  Start session detached.
  $cmd reopen           Open sessions for all mutt editor files sitting about."

if [ $# -gt 0 ] && [ "x$1" = xreopen ]
then
  shift
  xit=0
  [ $# -gt 0 ] || set -- "$HOME"/var/mutt/mutt-*[0-9]
  for msgfile
  do  [ ! -s "$msgfile" ] || ( set -x; "$0" -d "$msgfile" ) || xit=1
  done
  exit $xit
fi

mode_screen=-m
mode_tmux=
if [ $# -gt 0 ] && [ "x$1" = x-d ]
then
  shift
  mode_screen='-d -m'
  mode_tmux=-d
fi

[ $# = 1 ] || { echo "$usage" >&2; exit 2; }
filename=$1; shift

[ -s "$filename" ] || { echo "$cmd: expected non-empty file, got: $filename" >&2; exit 2; }

now=$( date '+%d%b%Y-%H:%M'|tr '[A-Z]' '[a-z]' )
subj=$( sed -n -e '/^$/q; y/	/ /; /^[Ss]ubject:/{ s/^[^:]*: *//; s/[^a-zA-Z0-9:]/_/g; s/___*/_/g; p; q; }' <"$filename" | tr : _ )

session_name=mutt-$now-$subj

set -- mutt -e 'set editor=vim-flowed' -e 'unset signature' -H "$filename"

if tmux start-server
then
  session_name=$( printf '%s\n' "$session_name" | tr : _ )
  shcmd=$( shqstr "$@" )
  set -x
  ## was "$shcmd"
  tmux new-session $mode_tmux -s "$session_name" -- "$@"
else
  session_name=$( printf '%s\n' "$session_name" | cut -c1-20 )
  set -x
  screen $mode_screen -S "$session_name" -- "$@"
fi
