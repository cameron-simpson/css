#!/bin/sh
#
# Yet another wrapper for notmuch, to construct a results maildir from a
# notmuch search.
#       - Cameron Simpson <cs@zip.com.au> 18apr2014
#

set -ue

dothreads=

cmd=`basename "$0"`
usage="Usage: $cmd [-t] notmuch-search-terms...
  -t    Include associated threads."

badopts=

while [ $# -gt 0 ]
do
  case $1 in
    -t) dothreads=1 ;;
    --) shift; break ;;
    -?*)echo "$cmd: unrecognised option: $1" >&2
        badopts=1
        ;;
    *)  break ;;
  esac
  shift
done

if [ $# = 0 ]
then
  echo "$cmd: missing notmuch-search-terms" >&2
  badopts=1
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

first=1
for term
do
  [ $first ] && { set --; first=; }
  case "$term" in
    :*)  term=`expr "x$term" : 'x:\(.*\)'` ;;
    *:*)    ;;
    *)      term=subject:$term ;;
  esac
  if [ $first ]
  then  set -- "$term"; first=
  else  set -- "$@" "$term"
  fi
done

exec 3<&0

mdir=$( mkdirn "$TMPDIR/notmuch-result" )
maildir "$mdir"

if [ $dothreads ]
then
  notmuch search --output=threads -- "$@" \
  | while read -r tid
    do  notmuch search --output=files -- "$tid"
    done
else
  notmuch search --output=files -- "$@"
fi \
| egrep '/(new|cur)/[^/]+$' \
| sort -u \
| xxargs arg1 -end "$mdir/new" set-x ln -i -s

mutt -e 'unset header_cache' -f "$mdir" <&3 3<&-
rm -r "$mdir"
