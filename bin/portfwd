#!/bin/sh -ue
#
# Run the named port forwards indefinitely.
#       - Cameron Simpson <cs@zip.com.au> 08jul2008
#

set -ue

: ${VARRUN:=$HOME/var/run}
: ${LOGDIR:=$HOME/var/log}
: ${PORTFWD_CONFIG:=$HOME/rc/ssh/portfwd}
: ${PORTFWD_SSH_CONFIG:=$HOME/rc/ssh/config-pf}
: ${USER:=`id -un`}

trace=set-x
once=
sshcfg=$PORTFWD_SSH_CONFIG
fwdcfg=$PORTFWD_CONFIG

cmd=`basename "$0"`
usage="Usage: $cmd [-1] [-F ssh_config] targets...
  -1    Once. Do not restart the tunnel if it dies.
  -F    Ssh configuration file with clause for target.
        Default from \$PORTFWD_SSH_CONFIG: $sshcfg
If a target starts with an upper case letter it is taken to be a group name,
and the targets are found by finding the first hostname in Host clauses with
the group name appended. Example: \"Host home ALL\""

opts=
badopts=

while [ $# -gt 0 ]
do
  case $1 in
    -1) once=1 ;;
    -F) sshcfg=$2 opts="$opts $1 $2"; shift ;;
    --) shift; break ;;
    -?*)echo "$cmd: unrecognised option: $1" >&2
        badopts=1
        ;;
    *)  break ;;
  esac
  shift
done

if [ $# = 0 ]
then
  echo "$cmd: no targets supplied" >&2
  sed -n 's/^ *[Hh][Oo][Ss][Tt][ 	][ 	]*/  /p' "$sshcfg" >&2
  echo >&2
  badopts=1
fi

# transmute group names into hosts
first=1
for target
do
  [ $first ] && set --
  case "$target" in
    [A-Z]*)
      onargs=$#
      set -- ${1+"$@"} \
             `sed -n 'y/	/ /
                      s/$/ /
                      s/^  *//
                      s/  */  /g
                      /^[Hh][Oo][Ss][Tt] .*'"$target"' /s/^[^ ]*  *\([^ A-Z][^ ]*\).*/\1/p' "$sshcfg"`
      if [ $# = $onargs ]
      then
        echo "$cmd: group \"$target\" does not match any Hosts in $sshcfg" >&2
        sed -n 's/^ *[Hh][Oo][Ss][Tt][ 	][ 	]*/  /p' "$sshcfg" >&2
        echo >&2
        badopts=1
      fi
      ;;
    *)set -- ${1+"$@"} "$target"
      ;;
  esac
done

[ $badopts ] && { echo "$usage" >&2; exit 2; }

if [ $# -gt 1 ]
then
  # multiple targets - dispatch portfwd for each
  ( for target
    do
      set-x "$0" $opts -- "$target" &
    done
    wait
  )
  exit $?
fi

target=$1
shift

# run main restart outer control via svcd
[ $once ] \
|| exec set-x \
          svcd -n "PORTFWD_$target" \
               -t 'flag -w PORTFWD_ANYWAY && exit 0
                   flag -w PORTFWD_DISABLE && exit 1
                   ssh-add -l >/dev/null || exit 1
                   netstat -rn | egrep '\''^(default|0\.0\.0\.0) +[1-9]'\'' >/dev/null || exit 1
                   [ -x "$HOME/bin-local/do-portfwd" ] || exit 0
                   "$HOME/bin-local/do-portfwd"
                  ' \
               -- "$0" -1 $opts -- "$target"

# getconfig target
#
# Set cfg_* vars from $fwdcfg[$target].
#
getconfig()
{ if [ -s "$fwdcfg" ]
  then
    _gc_wcv=`winclausevars "$fwdcfg" "$1" cfg`
    eval "$_gc_wcv"
  fi
}

cmd="$cmd $target"

# reload config on every pass
cfg_pidfile=portfwd.$target.pid
cfg_command=
cfg_outlog=portfwd-$target    # /dev/null
cfg_monitor=
getconfig "$target"
case $cfg_pidfile in
  /*) ;; *) cfg_pidfile=$VARRUN/$cfg_pidfile ;;
esac
case $cfg_outlog in
  /*) ;; *) cfg_outlog=$LOGDIR/$cfg_outlog ;;
esac

sshopts=-n
[ -n "$cfg_command" ] || sshopts="$sshopts -N"

alert "STARTING: $target"
$trace \
  tag_fd 2 "$target" \
  sshto $sshopts -F "$sshcfg" \
    -o "PermitLocalCommand=yes" -o "LocalCommand=</dev/null alert CONNECTED: $target &" \
    "$target" "$cfg_command" \
  >>"$cfg_outlog" </dev/null
alert "EXITED: $target"
