#!/bin/sh
#
# Set up a gpg-agent in daemon mode, much like rig-ssh-agent.
# Emit $GPG_AGENT_INFO to stdout.
#	- Cameron Simpson <cs@zip.com.au> 30mar2005
#

set -ue
exec 3>&1 1>&2

: ${GPG_AGENT_INFO:=}
: ${GNUPGHOME:=$HOME/rc/gnupg}

statefile=$HOME/var/run/gpg-agent-$HOST

{ [ -n "$GPG_AGENT_INFO" ] && gpg-agent; } \
|| \
{ unset GPG_AGENT_INFO
  [ -s "$statefile" ] && . "$statefile" && gpg-agent >/dev/null \
  || eval `gpg-agent --daemon --sh "--homedir=$GNUPGHOME" | tee "$statefile"`
}

echo "$GPG_AGENT_INFO" >&3
