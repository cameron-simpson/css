#!/bin/sh
#
# Set up a per-host ssh-agent in daemon mode if needed.
#	- Cameron Simpson <cs@zip.com.au> 30jul2001
#

set -ue

cmd=$0
usage="Usage: $cmd [statefile]"

trace=${DEBUG:+set-x}
statefile=
badopts=

while [ $# -gt 0 ]
do
  case $1 in
    --) shift; break ;;
    -?*)echo "$cmd: unrecognised option: $1" >&2
        badopts=1
        ;;
    *)  break ;;
  esac
  shift
done

[ $# = 0 ] || { statefile=$1; shift; }
[ $# = 0 ] || { echo "$cmd: extra arguments: $*" >&2; badopts=1; }

[ $badopts ] && { echo "$usage" >&2; exit 2; }

[ -n "$statefile" ] || statefile=`$trace ssh-agent-statefile` || exit 1
eval `$trace get-ssh-agent "$statefile" || echo false` && exit 0

# some machines don't have an ssh-agent:-(
agent=`$trace which ssh-agent` || exit 1
[ -x "$agent" ] || exit 1

export statefile
exec $trace bgproc \
  rmthen -f "$statefile" \
  $trace no-ssh-agent \
  $trace ssh-agent \
  $trace sh -c 'stash-ssh-agent "$statefile"; exec pause' \
  </dev/null
