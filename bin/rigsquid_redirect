#!/bin/sh -u
#
# Dispatch my squid - generally runs an adzapper.
#	- Cameron Simpson <cs@zip.com.au> 01jul2004
#

set -ue

: ${VARRUN:=$HOME/var/run}

cmd=$0
oargs=$*
usage="Usage: $cmd [peers]"

trace=set-x
case "$OS" in
  darwin)  dfltrc=/opt/local/etc/squid/squid.conf ;;
  *)       dfltrc=/etc/squid/squid.conf ;;
esac
[ -s "$dfltrc" ] || { echo "$cmd: no default squid.conf? ($dfltrc)" >&2; exit 1; }

rc=$HOME/tmp/squid.conf
pidf=$VARRUN/squid.pid
tplt=$HOME/rc/squid/tplt

$trace killpidfile -w "$pidf"

## old proxy-mode standalone redirector
##exec alog squid_redirect squid_redirect -P "8080:$SQUID"

(
  echo "# Generated on `date`."
  echo "# $0 $oargs"
  echo
  ( ##grep '^acl ' <"$dfltrc"
    env SQUID_PIDFILE=$pidf envsub -p '\{\{([A-Z]\w*)\}\}' <"$tplt"
    
    for parent
    do
      ( IFS=: set -- $parent
        if [ $# = 2 ]
        then
          echo "cache_peer $1 parent $2 0"
        else
          echo "$cmd: SKIPPING bad parent: $parent" >&2
        fi
      )
    done
    echo url_rewrite_program $HOME/bin/squid_redirect
    ##echo redirect_program $HOME/bin/squid_redirect
    echo url_rewrite_children 2
  ) \
  | patch-config -I -i "$dfltrc" \
  | grep '^[^#]'
) \
| $trace rewriteif -d "$rc"

cat "$rc"
exec $trace alog squid/cache.log squid -f "$rc"
