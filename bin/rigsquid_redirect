#!/bin/sh -u
#
# Dispatch my squid - generally runs an adzapper.
#	- Cameron Simpson <cs@zip.com.au> 01jul2004
#

: ${VARRUN:=$HOME/var/run}

cmd=$0
usage="Usage: $cmd [peers]"

trace=set-x
case "$OS" in
  darwin)  dfltrc=/opt/local/etc/squid/squid.conf ;;
  *)       dfltrc=/etc/squid/squid.conf ;;
esac
[ -s "$dfltrc" ] || { echo "$cmd: no default squid.conf? ($dfltrc)" >&2; exit 1; }

rc=$HOME/tmp/squid.conf
pidf=$VARRUN/squid.pid
tplt=$HOME/rc/squid/tplt

[ $# = 0 ] || { SQUID_PEERS=$*; export SQUID_PEERS; }

$trace killpidfile -w "$pidf"

## old proxy-mode standalone redirector
##exec alog squid_redirect squid_redirect -P "8080:$SQUID"

( ##grep '^acl ' <"$dfltrc"
  env SQUID_PIDFILE=$pidf envsub -p '\{\{([A-Z]\w*)\}\}' <"$tplt"
  mksquidpeers
  echo url_rewrite_program $HOME/bin/squid_redirect
  echo redirect_program $HOME/bin/squid_redirect
  echo url_rewrite_children 2
) | patch-config -I -i "$dfltrc" \
> "$rc"

bsed -s '/^$/d; /^#/d' "$rc"
cat "$rc"
exec $trace alog squid/cache.log squid -f "$rc"
