#!/bin/sh
#
# Invoke analog with arbitrary settings.
#       - Cameron Simpson <cs@zip.com.au> 12mar2012
#

set -ue

: ${TMPDIR:=/tmp}

cmd=`basename "$0"`
usage="Usage: $cmd -d reportdir template-analog-config SETTING=value... {/path/to/logfile|/path/to/logdir}..."

trace=eecho     ##set-x
reportdir=

badopts=

while [ $# -gt 0 ]
do
  case "$1" in
    -d) reportdir=$1; shift ;;
    --) shift; break ;;
    -?*)echo "$cmd: unrecognised option: $1" >&2; badopts=1 ;;
    *)  break ;;
  esac
  shift
done

if [ -z "$reportdir" ]
then
  echo "$cmd: missing -d reportdir" >&2
  badopts=1
fi

if [ $# = 0 ]
then
  echo "$cmd: missing template-analog-config" >&2
  badopts=1
else
  tplt=$1
  shift
  [ -f "$tplt" ] || { echo "$cmd: template config missing: $tplt" >&2
                      badopts=1
                    }
fi

tmppfx=$TMPDIR/$cmd.$$

trap 'rm -f "$tmppfx"*' 0
trap 'rm -f "$tmppfx"*; exit 1' 1 3 15

patchfile=$tmppfx-patch
>>"$patchfile"

while [ $# -gt 0 ]
do
  case "$1" in
    [A-Z]*=*)
      setting=`expr "x$1" : 'x\([A-Z][^=]*\)=.*'`
      value=`expr "x$1" : 'x[A-Z][^=]*=\(.*\)'`
      printf '%s %s\n' "$setting" "$value" >>"$patchfile"
      ;;
    *)break
      ;;
  esac
  shift
done

while [ $# -gt 0 ]
do
  case "$1" in
    /*)
      path=$1
      if [ -d "$path/." ]
      then find "$path/." -type f -exec printf 'LOGFILE "%s"\n' {} ';' >>"$patchfile"
      else printf 'LOGFILE "%s\n"' >>"$patchfile"
      fi
      ;;
    *)break ;;
  esac
  shift
done

[ $# = 0 ] || { echo "$cmd: unrecognised arguments: $*" >&2; badopts=1; }

[ $badopts ] && { echo "$usage" >&2; exit 2; }

conf=$reportdir/analog.conf
imagesdir=$reportdir

[ -d "$reportdir/." ] || $trace mkdir "$reportdir"
echo "OUTFILE $reportdir/index.html" >>"$patchfile"
[ -d "$imagesdir/." ] || $trace mkdir "$imagesdir"
echo "IMAGEDIR $imagesdir" >>"$patchfile"

cat "$patchfile"
$trace patch-config -o "$conf" "$tplt" "$patchfile"
$trace analog "+g$conf"
