#!/bin/sh
#
# Import a static website into an Amazon AWS S3 bucket for static serving.
#   - Cameron Simpson <cs@zip.com.au> 05dec2015
#

set -ue

: ${S3CFG:=$HOME/.s3cfg-$AWS_ID}

no_wget=
no_sync=
htdocs_dir=

cmd=$( basename "$0" )
usage="Usage: $cmd [--no-wget] [--no-sync] [-d htdocs-dir] fqdn s3-bucket-name
  --no-wget Do not update the htdocs tree from the source website.
  --no-sync Do not update the S3 bucket from the htdocs tree.
  -d htdocs-dir
            Use the specified directory as the htdocs tree; the default is
            taken from the FQDN."

badopts=

while [ $# -gt 0 ]
do
  case "$1" in
    --no-sync)  no_sync=1 ;;
    --no-wget)  no_wget=1 ;;
    -d)         htdocs_dir=$2; shift ;;
    --)         shift; break ;;
    -?*)        echo "$cmd: unrecognised option: $1" >&2
                badopts=1
                ;;
    *)          break ;;
  esac
  shift
done

if [ $# = 0 ]
then  echo "$cmd: missing fqdn" >&2
      badopts=1
else  fqdn=$1
      shift
fi

if [ $# = 0 ]
then  echo "$cmd: missing s3-bucket-name" >&2
      badopts=1
else  s3bucket=$1
      shift
fi

if [ $# -gt 0 ]
then
  echo "$cmd: extra arguments after s3-bucket-name: $*" >&2
  badopts=1
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

srcurl=http://$fqdn/
dsturl=s3://$s3bucket
[ -n "$htdocs_dir" ] || htdocs_dir=$fqdn

s3(){
  s3cmd -q -c "$S3CFG" ${1+"$@"}
}

setx(){
  ( set -x; "$@" )
}

xit=0

cd "$htdocs_dir"

if [ -z "$no_wget" ]
then
  setx wget -q -mp -nH "$srcurl" \
  || { echo "$cmd: warning: wget had errors, rerun with -nv for details" >&2; xit=1; }
fi

if [ -z "$no_sync" ]
then
  setx s3 -MP sync . "$dsturl"
  # repair
  for fixext in text/css:.css
  do
    mimetype=$( expr "x$fixext" : 'x\(.*\):.*' )
    suffix=$(   expr "x$fixext" : 'x.*:\(.*\)' )
    find * -type f -name "*$suffix" \
    | while read -r fixfile
      do
        ##setx s3 del "$dsturl/$fixfile"
        setx s3 -P -m "$mimetype" put "$fixfile" "$dsturl/$fixfile"
      done
  done
fi

exit $xit
