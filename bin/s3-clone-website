#!/bin/sh
#
# Import a static website into an Amazon AWS S3 bucket for static serving.
# 
#   - Cameron Simpson <cs@zip.com.au> 05dec2015
#

set -ue

: ${S3CFG:=$HOME/.s3cfg-$AWS_ID}

cmd=$( basename "$0" )
usage="Usage: $cmd fqdn s3-bucket-name"

badopts=

if [ $# = 0 ]
then  echo "$cmd: missing fqdn" >&2
      badopts=1
else  fqdn=$1
      shift
fi

if [ $# = 0 ]
then  echo "$cmd: missing s3-bucket-name" >&2
      badopts=1
else  s3bucket=$1
      shift
fi

if [ $# -gt 0 ]
then
  echo "$cmd: extra arguments after s3-bucket-name: $*" >&2
  badopts=1
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

set -x
srcurl=http://$fqdn/
dsturl=s3://$s3bucket
vhsubdir=$fqdn

s3(){
  s3cmd -c "$S3CFG" ${1+"$@"}
}

wget -nv -mp "$srcurl"
cd "$vhsubdir"
s3 -MP sync . "$dsturl"
# repair
for fixext in text/css:.css
do
  mimetype=$( expr "x$fixext" : 'x\(.*\):.*' )
  suffix=$(   expr "x$fixext" : 'x.*:\(.*\)' )
  find * -type f -name "*$suffix" \
  | while read -r fixfile
    do
      s3 del "$dsturl/$fixfile"
      s3 -P -m "$mimetype" put "$fixfile" "$dsturl/$fixfile"
    done
done
