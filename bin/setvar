#!/usr/bin/python -tt
#
# Script to compute various environment parameters.
# Must be sourced, and defines the shell function setvar() as a consequence.
#	- Cameron Simpson, 18may1993
#
# Removed -n option.
# Recoded not to recurse to bypass Sys5 shell braindamage. - cameron, 30jul1993
# Recoded in Perl to bypass more shell braindamage.
# You don't source it anymore. - cameron, 07jan1994
# Added -f to force resetting variables. - cameron, 11jan1994
# Generalisation. - cameron, 02dec1998
# Python recode, syntax change, bootstrap. - cameron 23mar2008
#

from getopt import getopt, GetoptError
import os
import pwd
import sys
from sets import Set
import cs.misc
from cs.misc import debug, cmderr

force=False     # don't reset existing variables
noAction=False  # don't exec command, recite var assignments on stdout
isset=Set()
filevars={}

def env(var):
  ''' Obtain the value of an environment variable.
      Returns None if the value cannot be determined.
  '''
  global force, isset
  if (not force or var in isset) and var in os.environ:
    return os.environ[var]
  val=filevar(var)
  if val is None:
    val=bootvar(var)
  if val is not None:
    setvar(var,val)
  return val

def bootvar(var):
  ''' Compute the value of a variety of variable from scratch.
  '''
  if var == "CPU":
    cpu=os.uname()[4].lower()
    if cpu == 'power macintosh':
      cpu='ppc'
    return cpu
  if var == "HOME":
    return pwd.getpwuid(os.geteuid())[5]
  if var == "HOST":
    hostname=env("HOSTNAME")
    if '.' in hostname:
      host, hostdomain = hostname.split('.',1)
    else:
      host = hostname
    return host
  if var == "HOSTDOMAIN":
    hostname=env("HOSTNAME")
    host, hostdomain = hostname.split('.',1)
    return hostdomain
  if var == "HOSTNAME":
    import socket
    return socket.getfqdn()
  if var == "OS":
    opsys=os.uname()[0].lower()
    if opsys == "sunos":
      opsys='solaris'
    return opsys
  if var == "USER":
    return pwd.getpwuid(os.geteuid())[0]
  if var == "PYTHON_VV":
    return "%s.%s" % sys.version_info[:2]
  if var == "VENDOR":
    vendor=None
    if os.path.isfile('/etc/fedora-release'):
      vendor='fedora'
    elif os.path.isfile('/etc/redhat-release'):
      vendor='redhat'
    elif os.path.isfile('/etc/gentoo-release'):
      vendor='gentoo'
    else:
      opsys=env("OS")
      if opsys == "darwin":
        vendor="apple"
    return vendor
  return None

def filevarexts():
  hostname=env("HOSTNAME")
  if hostname is not None:
    yield "@%s" % hostname
  host=env("HOST")
  systemid=env("SYSTEMID")
  if host is not None:
    if systemid is not None:
      yield "@%s.%s" % (host, systemid)
    yield "@%s" % host
  if systemid is not None:
    yield "@%s" % systemid
  arch=env("ARCH")
  if arch is not None:
    yield ".%s" % arch
  yield None

doingFilevar=Set()
def filevar(var):
  if var in doingFilevar:
    debug("recursion in filevar(%s)" % var)
    return None
  doingFilevar.add(var)
  global filevars
  for ext in filevarexts():
    if ext is None:
      evar=var
    else:
      evar=var+ext
    if evar in filevars:
      doingFilevar.remove(var)
      return paramsubst(filevars[evar])

  doingFilevar.remove(var)
  return None

def setvar(var,val=None):
  if val is not None:
    if os.environ.get(var) != val:
      os.environ[var]=val
      isset.add(var)
    return val

  val=env(var)
  if val is None:
    debug("failed to setvar(%s)" % var)
  else:
    debug("%s=%s" % (var, val))
    os.environ[var]=val
    isset.add(var)
  return val

def paramsubst(val):
  newval=''
  while '$' in val:
    val0, val1 = val.split('$',1)
    newval+=val0
    pos=0
    while pos < len(val1) and (val1[pos].isalnum() or val1[pos] == '_'):
      pos+=1
    val=val1[pos:]
    subvar=val1[:pos]

    subval=env(subvar)
    if subval is None:
      debug("can't look up $%s" % subvar)
    else:
      newval+=subval

  newval+=val

  return newval

def loadfilevars(path):
  global filevars
  debug("load %s" % path)
  for line in open(path):
    assert line[-1:] == '\n', "%s: unexpected EOF" % path
    if line[0] == '#' or line[0] == '\n':
      continue
    line=line[:-1]
    eqpos=line.find('=')
    assert eqpos > 0, "%s: bad line: %s" % (path, line)
    var, val = line.split('=', 1)
    filevars[var]=val

def listfilevars():
  global filevars
  V=Set()
  debug("filevars=%s" % filevars)
  for v in filevars.keys():
    if '.' in v:
      v, v2 = v.split('.',1)
    if '@' in v:
      v, v2 = v.split('@',1)
    debug("filevar %s" % v)
    V.add(v)
  return V

def doCommand(argv):
  debug("doCommand %s" % argv)
  op=argv[0]
  argv=argv[1:]
  if op == "addprefix":
    for arg in argv:
      arg=paramsubst(arg)
      if not os.path.isabs(arg):
        arg=os.path.join('/opt',arg)
      setvar('PATH',"%s:%s/bin:%s/sbin" % (os.environ['PATH'], arg, arg))
      setvar('MANPATH',"%s:%s/man:%s/share/man" % (os.environ['MANPATH'], arg, arg))
      setvar('PERL5LIB',"%s: %s/lib/perl5" % (os.environ['PERL5LIB'], arg))
      setvar('PYTHONPATH',"%s:%s/lib/python%s" % (os.environ['PYTHONPATH'], arg, env('PYTHON_VV')))
  elif op == "insprefix":
    argv.reverse()
    for arg in argv:
      arg=paramsubst(arg)
      if not os.path.isabs(arg):
        arg=os.path.join('/opt',arg)
      setvar('PATH',"%s/bin:%s/sbin:%s" % (arg, arg, os.environ['PATH']))
      setvar('MANPATH',"%s/man:%s/share/man:%s" % (arg, arg, os.environ['MANPATH']))
      setvar('PERL5LIB',"%s/lib/perl5:%s" % (arg, os.environ['PERL5LIB']))
      setvar('PYTHONPATH',"%s/lib/python%s:%s" % (arg, env('PYTHON_VV'), os.environ['PYTHONPATH']))
  elif op == "python":
    exec " ".join(argv)
  elif op == "use":
    global envpath
    for arg in argv:
      if os.path.isabs(arg):
        doFile(arg)
      else:
        for path in envpath:
          fpath=os.path.join(path,arg)
          if os.path.isfile(fpath):
            doFile(fpath)
            break
  elif op == "var":
    for arg in argv:
      if arg == "*":
        for var in listfilevars():
          setvar(var)
      else:
        for var in paramsubst(arg).split(' '):
          setvar(var)
  else:
    cmderr("unsupported operation: %s" % op)

def doFile(path):
  debug(`path`)
  ocmd=cs.misc.cmd
  cs.misc.cmd="%s: %s" % (ocmd, path)
  oline=""
  for line in open(path):
    if line[-1:] != '\n':
      cmderr("unexpected EOF")
      break
    line=line[:-1]
    if len(line) == 0 or line[-1] != '\\':
      oline+=line
      argv=oline.split()
      if len(argv) > 0 and argv[0][0] != '#':
        doCommand(argv)
      oline=""
    else:
      oline+=" "+line[:-2]
  if len(oline) > 0:
    cmderr("unterminated slosh line")
  cs.misc.cmd=ocmd

def cleanpath(*vars):
  for var in vars:
    keep=[]
    for path in os.environ[var].split(':'):
      if len(path) > 0 and os.path.exists(path):
        keep.append(path)
    os.environ[var]=":".join(keep)

opts, args = getopt(sys.argv[1:], 'fn')
debug("args=%s" % args)
for opt, val in opts:
  if opt == '-f':
    force=True
  elif opt == '-n':
    noAction=True
  else:
    cmderr("unimplemented option: %s" % opt)
    sys.exit(2)

envpath=os.environ.get('ENVPATH')
if envpath is None:
  envpath='%s/.setvar:/etc/setvar' % env('HOME')
envpath=envpath.split(':')
renvpath=envpath[:]
renvpath.reverse()

for path in renvpath:
  varfile=os.path.join(path,'var')
  if os.path.isfile(varfile):
    loadfilevars(varfile)

setvar("HOSTNAME")
setvar("SYSTEMID")

if len(args) == 0:
  args=('var *',)
for arg in args:
  if ' ' in arg:
    doCommand(arg.split())
  else:
    setvar(arg)

cleanpath('PATH','MANPATH','PYTHONPATH','PERL5LIB')

if noAction:
  import cs.sh
  vars=list(isset)
  vars.sort()
  for var in vars:
    print "%s=%s; export %s;" % (var, cs.sh.quotestr(os.environ[var]), var)
else:
  cmderr("action mode not supported")
  sys.exit(1)
