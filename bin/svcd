#!/bin/sh
#
# Daemon to run and restart a command that provides a service, such
# as an ssh port forward.
#       - Cameron Simpson <cs@zip.com.au> 10dec2012
#

set -ue

: ${LOGDIR:=$HOME/var/log}
: ${VARRUN:=$HOME/var/run}

logdir=$LOGDIR/svc
name=
flag_disable=
pidfile=
trace=${DEBUG:+set-x}
once=
testrate=7
killtime=5
testcmd=

cmd=`basename "$0"`
usage="Usage: $cmd [-1] [-n name] [-t testcmd] [-x] command [args...]"

badopts=

while [ $# -gt 0 ]
do
  case $1 in
    -1) once=1 ;;
    -n) name=$2; shift ;;
    -t) testcmd=$2; shift ;;
    -x) trace=set-x ;;
    --) shift; break ;;
    -?*)echo "$cmd: unrecognised option: $1" >&2
        badopts=1
        ;;
    *)  break ;;
  esac
  shift
done

if [ $# = 0 ]
then
  echo "$cmd: missing command" >&2
  badopts=1
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

if [ -n "$name" ]
then
  [ -z "$pidfile" ] && pidfile=$VARRUN/$name.pid
  [ -z "$flag_disable" ] && flag_disable=`echo "$name" | tr '[a-z]' '[A-Z]'`_DISABLE
  pfx="$cmd $name"
else
  pfx="$cmd $1"
fi

ok()
{
  [ -z "$flag_disable" ] || not flag -w "$flag_disable" || return 1
  [ -z "$testcmd" ] || sh -c "$testcmd" || return 1
  return 0
}

killsubproc()
{
  if [ -n "$pidfile" ]
  then [ ! -s "$pidfile" ] || $trace killpidfile -W "$killtime" -- "$pidfile"
  else [ -z "$subpid" ] || $trace killpids -W "$killtime" -- "$subpid"
  fi
}

(
  subpid=
  trap 'killsubproc; exit 1' 1 2 3 15

  while :
  do
    if ok
    then
      # dispatch actual service process
      pfx "$pfx" $trace "$@" &
      subpid=$!
      [ -n "$pidfile" ] && echo "$subpid" >"$pidfile"

      # dispatch monitor to terminate service daemon if no longer ok to run
      ( ( while :
          do
            sleep "$testrate"
            kill -0 "$subpid" 2>/dev/null || break
            ok || break
          done
          kill -0 "$subpid" 2>/dev/null && killsubproc
        ) &
      )

      wait
      subpid=

      [ -n "$pidfile" ] && rm -f "$pidfile"
      [ $once ] && break
    fi
    $trace sleep "$testrate"
  done
)

exit 0
