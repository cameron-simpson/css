#!/bin/sh
#
# Daemon to run and restart a command that provides a service, such
# as an ssh port forward.
#       - Cameron Simpson <cs@zip.com.au> 10dec2012
#

set -ue

: ${LOGDIR:=$HOME/var/log}
: ${VARRUN:=$HOME/var/run}

logdir=$LOGDIR/svc
name=
flag_disable=
pidfile=
trace=${DEBUG:+set-x}
once=
testrate=7
killtime=5
testcmd=
dolock=
lockname=

cmd=`basename "$0"`
usage="Usage: $cmd [-1] [-n name] [-t testcmd] [-x] command [args...]"

badopts=

opts=

while [ $# -gt 0 ]
do
  case $1 in
    -1) once=1 opts="$opts $1" ;;
    -l) dolock=1 ;;
    -L) dolock=1 lockname=$2; shift ;;
    -n) name=$2; shift ;;
    -t) testcmd=$2; shift ;;
    -x) trace=set-x opts="$opts $1" ;;
    --) shift; break ;;
    -?*)echo "$cmd: unrecognised option: $1" >&2
        badopts=1
        ;;
    *)  break ;;
  esac
  shift
done

if [ $# = 0 ]
then
  echo "$cmd: missing command" >&2
  badopts=1
fi

if [ $dolock ]
then
  # derive lock name if unspecified
  if [ -z "$lockname" ]
  then
    if [ -z "$name" ]
    then
      echo "$cmd: no lock name (-L) and no svcd name (-n)" >&2
      badopts=1
    else
      lockname=svcd-$name
    fi
  fi
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

[ $dolock ] \
&& exec $trace lock -1 "$lockname" "$0" $opts -n "$name" -t "$testcmd" -- "$@"

if [ -n "$name" ]
then
  [ -z "$pidfile" ] && pidfile=$VARRUN/$name.pid
  [ -z "$flag_disable" ] \
  && flag_disable=`echo "$name" | tr -- '-[a-z]' '_[A-Z]'`_DISABLE
  pfx="$cmd $name"
else
  pfx="$cmd $1"
fi

if [ -n "$pidfile" ] && pid=`ifpid -q -v "$pidfile"`
then
  echo "$cmd: $pidfile: already running, pid $pid:" `ps -o args -p "$pid" 2>/dev/null | sed 1d` >&2
  exit 1
fi

ok()
{
  [ -z "$flag_disable" ] || not flag -w "$flag_disable" || return 1
  [ -z "$testcmd" ] || sh -c "$testcmd" || return 1
  return 0
}

killsubproc()
{
  if [ -n "$pidfile" ]
  then [ ! -s "$pidfile" ] || $trace killpidfile -W "$killtime" -- "$pidfile"
  else [ -z "$subpid" ] || $trace killpids -W "$killtime" -- "$subpid"
  fi
}

subpid=
trap 'killsubproc; exit 1' 1 2 3 15

while : SVCD MAIN LOOP "$pfx"
do
  if ok
  then
    # dispatch actual service process
    pfx "$pfx" $trace "$@" &
    subpid=$!
    [ -n "$pidfile" ] && echo "$subpid" >"$pidfile"

    # dispatch monitor to terminate service daemon if no longer ok to run
    ( ( while : SVCD SUBPID MONITOR "$pfx"
        do
          sleep "$testrate"
          kill -0 "$subpid" 2>/dev/null || exit 0
          ok || break
        done
        kill -0 "$subpid" 2>/dev/null && killsubproc
      ) &
    )

    wait "$subpid" || not kill -0 "$subpid" 2>/dev/null || killsubproc
    subpid=
    [ -n "$pidfile" ] && rm -f "$pidfile"

    [ $once ] && break
  fi
  $trace sleep "$testrate"
done

exit 0
