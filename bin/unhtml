#!/bin/sh
#
# Mangle HTML to put URLs inline with the links for easy grabbing.
#	- Cameron Simpson <cs@zip.com.au> 17may2002
#

cmd=$0
usage="Usage: $cmd [-a] [-c] [-cols] [files...]
	-a	No anchors - don't mangle HTML to show URLs.
	-c	Clean: run code through htclean.
	-cols	Use \"cols\" columns."

mangle=1
cols=
clean=

# load default options
eval "set -- $UNHTML_OPTS "' ${1+"$@"}'

badopts=
while :
do
  case "$1" in
    -a)  mangle= ;;
    +a)	 mangle= ;;
    -c)  clean=1 ;;
    +c)	 clean= ;;
    -[1-9]*) cols=`expr "x$1" : 'x-\(.*\)'` ;;
    --)  shift; break ;;
    -?*) echo "$cmd: unrecognised option: $1" >&2; badopts=1 ;;
    *)   break ;;
  esac
  shift
done

[ $badopts ] && { echo "$usage" >&2; exit 2; }

[ -n "$cols" ] || cols=`ttysize|awk '{print$1}'`
[ -n "$cols" ] && cols="-cols $cols"

if [ $# = 0 ]
then  detab
else  for file
      do  case "$file" in
	    -)				cat ;;
	    http://* | ftp://* )	wcat "$file" ;;
	    *)				cat "$file" ;;
	  esac
      done
fi \
| if [ $clean ]; then htclean; else cat; fi \
| LC_ALL=C html-unsplit \
| LC_ALL=C sed 's|</ *[Aa] *>|&|g' \
| LC_ALL=C tr '\015' '\012' \
| if [ $mangle ]
  then perl -pe 's;<a\s[^>]*\bhref="((http|https):[^"]*)">; \1 &;gi'
  else cat
  fi \
| w3m $cols -dump -T text/html \
| LC_ALL=C sed 's/[ 	][ 	]*$//'
