#!/bin/sh -ue
#
# Install and publish css from my development copy.
#	- Cameron Simpson <cs@zip.com.au> 09apr1997
#

: ${TMPDIR:=/tmp}
: ${OPTCSS:=/opt/css}

cssweb=$HOME/@/ezos/html/cs/css
adzapweb=$HOME/@/adzapper.sf/html/scripts
quick=

cmd=`basename "$0"`
usage="Usage: $cmd [-q] [-n] [pushhosts...]"

xit=0

needhost $HOMEHOST@home || exit 2

umask 22

[ $# -gt 0 ] && [ "x$1" = x-q ] && { quick=1; shift; }

set -ue

unset tmpdir
trap '[ ! -d "$tmpdir" ] || rm -rf $tmpdir' 0
trap '[ ! -d "$tmpdir" ] || rm -rf $tmpdir; exit 1' 1 2 13 15
tmpdir=`mkdirn "$TMPDIR/$cmd"`

lastrelease=`cs-release lastrelease`
lasttag=release-$lastrelease
cssdatedir=css-$lastrelease
dstdir=$tmpdir/$cssdatedir

hg archive -t files -r "$lasttag" "$dstdir"

( cd "$dstdir"

  rsync -aHL --ignore-existing bin/synonyms/ bin/
  rm -rf bin/synonyms bos csiro defunct hacks misc stubs unsw

  cp $HOME/rc/java/au.com.zip.cs.jar lib/

  echo adzapper...
  for f in squid_redirect testpageurls testzap
  do cp "$adzapweb/$f" bin/
     chmod a+rx "bin/$f"
  done

  echo CHANGELOG.txt...
  hglog -r "$lasttag:0" >CHANGELOG.txt

  echo 1INDEX.txt...
  ( cd bin; tag_fd 2 1INDEX.txt mkscriptndx * | sort ) >1INDEX.txt

  echo man...
  rsync -aH "$OPTCSS/man/." man/
  myke "MANDIR=$dstdir/man" _man || echo myke _man fails, ignoring...
)

# deploy to local production
echo "update $OPTCSS..."
pfx "$OPTCSS" \
  rsync -aH --delete "$dstdir/" "$OPTCSS/"
ln -s .. "$OPTCSS/html/optcss"

# update the web tree
echo css-$lastrelease.tar.gz...
( cd "$tmpdir"
  tar cf "$cssweb/$cssdatedir.tar.gz" "$cssdatedir"
  rm -f "$cssweb/css.tar.gz"
  ln -s "$cssdatedir.tar.gz" "$cssweb/css.tar.gz"
)

echo CHANGELOG.rss...
hg-rss >"$dstdir/html/CHANGELOG.rss"

echo "update $cssweb..."
pfx "$cssweb" qrsync -a --exclude=/optcss "$dstdir/html/" "$cssweb/"
