#!/bin/sh -ue
#
# Install and publish css from my development copy.
#	- Cameron Simpson <cs@zip.com.au> 09apr1997
#

: ${TMPDIR:=/tmp}
: ${OPTCSS:=/opt/css}

cssweb=$HOME/@/ezos/html/cs/css
adzapweb=$HOME/@/adzapper.sf/html/scripts
quick=

cmd=`basename "$0"`
usage="Usage: $cmd [-q] [-n] [pushhosts...]"

xit=0

needhost $HOMEHOST@home || exit 2

umask 22

[ $# -gt 0 ] && [ "x$1" = x-q ] && { quick=1; shift; }

unset tmpdir
trap '[ ! -d "$tmpdir" ] || rm -rf $tmpdir' 0
trap '[ ! -d "$tmpdir" ] || rm -rf $tmpdir; exit 1' 1 2 13 15
tmpdir=`mkdirn "$TMPDIR/$cmd"`
cssdatedir=css-`date +%Y%m%d`
dstdir=$tmpdir/$cssdatedir
mkdir "$dstdir"

set -ue

echo HG tree...
( 
  hg manifest \
  | sed '
         /^bin\/synonyms\//d
         /^bin\//b ok
         /^etc\//b ok
         /^lib\//b ok
         /^man\//b ok
         /^html\//b ok
         /\//d
         :ok'
) \
| cpio -pmd "$dstdir"

echo synonyms...
rsync -aHL --ignore-existing bin/synonyms/. "$dstdir/bin/."

echo au.com.zip.cs.jar...
cp $HOME/rc/java/au.com.zip.cs.jar "$dstdir/lib/."

echo adzapper...
for f in squid_redirect testpageurls testzap
do cp "$adzapweb/$f" "$dstdir/bin/."
   chmod a+rx "$dstdir/bin/$f"
done

echo CHANGELOG.txt...
hglog >"$dstdir/CHANGELOG.txt"

echo 1INDEX.txt...
( cd bin; tag_fd 2 1INDEX.txt mkscriptndx * | sort ) >"$dstdir/1INDEX.txt"

echo man...
rsync -aH "$OPTCSS/man/." "$dstdir/man/."
myke "MANDIR=$dstdir/man" _man || echo myke _man fails, ignoring...

# deploy to local production
echo "update $OPTCSS..."
pfx "$OPTCSS" \
  rsync -aH --delete \
        --include=CHANGELOG.txt \
        --include=/bin \
        --include=/etc \
        --include=/html \
        --include=/lib \
        --include=/man \
        '--exclude=/*/' \
        "$dstdir/." "$OPTCSS/."
ln -s .. "$OPTCSS/html/optcss"

# update the web tree
echo css.tar.gz...
( cd "$tmpdir"
  set -- `find -H "$cssdatedir" -type f -print`
  [ $# = 0 ] && { echo "NO ARGS!" >&2; ls -ld "$cssdatedir" >&2; exit 1; }
  cp "$cssweb/css.tar.gz" "$dstdir/html/."
  ls -tdr "$@" | tar chTf - - | rewriteif "$dstdir/html/css.tar.gz" gzip -v -n -9
)
echo CHANGELOG.rss...
hg-rss >"$dstdir/html/CHANGELOG.rss"

echo "update $cssweb..."
pfx "$cssweb" qrsync -a --exclude=/optcss "$dstdir/html/." "$cssweb/."
