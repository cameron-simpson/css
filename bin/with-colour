#!/bin/sh -ue
#
# Perform command with output in particular colour.
#       - Cameron Simpson <cs@zip.com.au> 08jul2007
#

: ${WITH_COLOUR_ON:=''}

cmd=$0
usage="Usage: $cmd colour command [args...]"

badopts=

if [ $# = 0 ]
then
  echo "$cmd: missing colour" >&2
  badopts=1
else
  colour=$1
  shift

  if [ $# = 0 ]
  then
    echo "$cmd: missing command" >&2
    badopts=1
  fi
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

on= off=
case $colour in
  normal)
    on= off= ;;
  reverse|standout|bold)
    on=`tput smso` && off=`tput rmso` ;;
  it|italic)
    on=`tput sitm` && off=`tput ritm` ;;
  ul|underline)
    on=`tput smul` && off=`tput rmul` ;;
  sl|status)
    on=`tput tsl` && off=`tput fsl` ;;
  black)
    on=`tput setaf 0 2>/dev/null || tput setaf 0 0 0 2>/dev/null || tput setf 0 2>/dev/null` && off=`tput op` ;;
  red)
    on=`tput setaf 1 2>/dev/null || tput setaf 1 0 0 2>/dev/null || tput setf 4 2>/dev/null` && off=`tput op` ;;
  green)
    on=`tput setaf 2 2>/dev/null || tput setaf 2 0 0 2>/dev/null || tput setf 2 2>/dev/null` && off=`tput op` ;;
  yellow)
    on=`tput setaf 3 2>/dev/null || tput setaf 3 0 0 2>/dev/null || tput setf 6 2>/dev/null` && off=`tput op` ;;
  blue)
    on=`tput setaf 4 2>/dev/null || tput setaf 4 0 0 2>/dev/null || tput setf 1 2>/dev/null` && off=`tput op` ;;
  magenta)
    on=`tput setaf 5 2>/dev/null || tput setaf 5 0 0 2>/dev/null || tput setf 5 2>/dev/null` && off=`tput op` ;;
  cyan)
    on=`tput setaf 6 2>/dev/null || tput setaf 6 0 0 2>/dev/null || tput setf 3 2>/dev/null` && off=`tput op` ;;
  white)
    on=`tput setaf 7 2>/dev/null || tput setaf 7 0 0 2>/dev/null || tput setf 7 2>/dev/null` && off=`tput op` ;;
  *)
    echo "$cmd: unsupported colour \"$colour\"" >&2
    ;;
esac

# no sequence? just run the command
[ -n "$on" ] || exec "$@"

xit=0
printf "%s" "$on"
env "WITH_COLOUR_ON=$on" "$@" || xit=$?
printf "%s%s" "$off$WITH_COLOUR_ON"
exit $xit
