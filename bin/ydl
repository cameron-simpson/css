#!/bin/sh
#
# Helper for youtube-dl. Downloads to $DL/v, optionally via at(1) to utilise an off peak period.
# - Cameron Simpson <cs@cskk.id.au>
#

set -ue

cmd=$0
usage="Usage: $0 [hh:mm{am,pm}] URLs..."

trace=
[ -t 2 ] && trace=set-x

dldir=${DL:-$HOME/dl}/v
when=
proxy=${https_proxy:-''}

badopts=

if [ $# -gt 0 ]
then
  case "$1" in
    [0-9]:[0-9][0-9][ap]m | [1-9]:[0-9][0-9][ap]m)
        when=$1
        shift ;;
  esac
fi

if [ $# = 0 ]
then
  echo "$cmd: missing URLs" >&2
  badopts=1
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

[ -z "$proxy" ] || set -- --proxy "$proxy" "$@"
[ -d "$dldir" ] || $trace mkdir -p "$dldir"

cd "$dldir"
if [ -n "$when" ]
then
    set -- youtube-dl "$@"
    $trace echo "$*" | $trace at "$when"
else
    set -- youtube-dl --console-title ${1+"$@"}
    $trace "$@"
fi
