#!/bin/sh
#
# Take a log message and attachment data on stdin
# and log it appropriately.
#	- Cameron Simpson <cs@zip.com.au> 09jul2004
#

: ${TMPDIR:=/tmp}
: ${USER:=`whoami`}
: ${BUGSYSTEMS:='dlog logger'}

cmd=`basename "$0"`
usage="Usage: $cmd logline < attachment-data"

[ $# = 1 ] || { echo "$usage" >&2; exit 2; }
logmsg=$1; shift

[ -n "$BUGSYSTEMS" ] || BUGSYSTEMS=dlog

tmpf=$TMPDIR/bugids$$
trap 'rm -f "$tmpf"' 0 1 2 13 15
detab | unbs | unctrl >"$tmpf" || exit 1

case " $BUGSYSTEMS " in
  *' dlog '*)	dlog "$logmsg" ;;
esac
case " $BUGSYSTEMS " in
  *' mailto:'*)
		echo "$BUGSYSTEMS" \
		| tr ' ' '\012' \
		| sed '/^mailto:/!d
		       s/^mailto://
		       s/?/ /' \
		| \
		{
		  # ensure no spurious envvars
		  params=`env | sed -n 's/^\(PARAM_[A-Za-z0-9_]*\)=.*/\1/p'`
		  eval unset $params	# no quotes to turn newlines into spaces

		  while read addr args
		  do
		    hdrs="To: $addr"
		    subj=$logmsg

		    ( qsvals=`query_string2sh "$args"`
		      eval "$qsvals"
		      [ -n "$PARAM_subject" ] && subj="$subj: $PARAM_subject"

		      echo "To: $addr"
		      echo "Subject: $subj"
		      echo "X-Buglog: `date`"
		      echo
		      cat "$tmpf"
		    ) | sendmail -oi "$addr"
		  done
		}
		;;
esac
case " $BUGSYSTEMS " in
  *' ddts '*)	ddtsids=`echo "$logmsg" | ddtsids`
		[ -n "$ddtsids" ] && mailif -s "$logmsg" $ddtsids < "$tmpf"
		;;
esac
case " $BUGSYSTEMS " in
  *' logger '*)	logger -t buglog -- "$USER: $logmsg" ;;
esac

exit 0
