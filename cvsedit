#!/bin/sh
#
# Update a file, edit it, run a commit, commit the file.
#	- Cameron Simpson <cs@zip.com.au> 05mar1997
#

cmd=`basename "$0"`
usage="Usage: $cmd [-m logmessage] file [command [args...]]
	-m logmessage	Specify log message."

cameron=
[ "x$USER" = xcameron ] && cameron=1

msg=$CVSEDIT_MSG
if [ -n "$msg" ]
then  havemsg=1
else  havemsg=
fi

dodl=$cameron
dodiff=1

badopts=

while :
do  case $1 in
	-m)	havemsg=1 msg=$2; shift ;;
	--diff)	dodiff=1 ;;
	--no-diff) dodiff= ;;
	--dl)	dodl=1 ;;
	--no-dl) dodl= ;;
	-?*)	echo "$cmd: unrecognised option: $1" >&2; badopts=1 ;;
	--)	shift; break ;;
	*)	break ;;
    esac
    shift
done

if [ $# = 0 ]
then  echo "$cmd: missing file" >&2
      badopts=1
else  file=$1
      shift
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

if [ ! -f "$file" ]
then
      echo "$cmd: $file: not a regular file" >&2
      exit 1
fi

ifcvs "$file" || exit $?

umask 2

dir=`dirname "$file"`
base=`basename "$file"`

editcmd=$*
[ $# = 0 ] && { set x "${EDITOR-vi}"; shift; }

( cd "$dir" || exit 1
  cvs update "$base" || exit $?
  cvs diff "$base" || { echo "Uncommited changes already exist in $base." >&2
			echo "Please commit them before proceeding." >&2
			exit 1
		      }

  [ ! -d CVS/Base ] || cvs edit "$base" || exit $?
  chmod +w "$base"
) || exit 1

"$@" "$file"
editxit=$?

[ $dodiff ] \
&& ( cd "$dir" || exit 1
     cvs diff "$base"
   )

[ $editxit = 0 ] || ask "$* failed - really commit the file" || exit 1

[ $havemsg ] || { necho "Log message? "
		  read msg
		} || { echo "$cmd: commit cancelled - file in modified state" >&2
		       exit 1
		     }

if [ $dodl ] && [ -n "$msg$editcmd" ]
then
    case "$file" in /*) pwdpfx= ;; *) pwdpfx="`pwd`: " ;; esac
    dl=`echo "cvsedit $pwdpfx$file $editcmd: $msg" | entilde`
    dl "$dl"
fi

( cd "$dir" || exit 1
  exec cvs commit -m "$msg" "$base"
)
