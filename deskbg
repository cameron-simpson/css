#!/bin/sh -u
#
# Set the root background on per-desktop basis.
#	- Cameron Simpson <cs@zip.com.au> 02feb2004
#

: ${DESKTOPSET:=desktop}

cmd=$0
usage="Usage: $cmd [-] [-d desk] imagefiles...
	-	Do nothing. Recite fvwm commands.
	-d desk	Specify desk number to affect.
		Default desk is the current desk.
		The desk \"-\" means the global default.
	The imagefile \"\" means remove the per desk setting for this desk."

desk=
doit=1 dasharg= towm=fvwmcmd

badopts=

[ $# -gt 0 ] && [ "x$1" = x-  ] && { doit=; dasharg=$1; towm=echo; shift; }
[ $# -gt 0 ] && [ "x$1" = x-d ] && { desk=$2; shift; shift; }
[ $# -gt 0 ] && [ "x$1" = x-- ] && shift

if [ $# = 0 ]
then
    echo "$cmd: missing imagefile" >&2
    badopts=1
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

perdesk=1
case "$desk" in
  ''|.)	desk=`currentdesk` || exit 1 ;;
  -)	desk= perdesk= ;;
esac

if [ -z "$*" ]
then
    # flush background
    bg=
    if [ $perdesk ]
    then [ $doit ] && desktop -r "$desk" rootbg
    fi
else
    srcargs=$*
    first=1
    for arg
    do
      if [ $first ]
      then
	set --
	first=
      fi
      cached=`filecache "$arg"` || cached=$arg
      set -- ${1+"$@"} "$cached"
    done

    # compute new background
    rootbg=`mkwall "$@"` || exit 1

    # note supplied images
    if [ $doit ]
    then
      if [ $perdesk ]
      then
	desktop "$desk" rootbg "$*"
	desktop "$desk" rootbg_src "$srcargs"
      else
	lastvalue "rootbg-$HOST" "$*"
	lastvalue "rootbg" "$*"
	lastvalue "rootbg_src" "$srcargs"
      fi
    fi

    bg=$rootbg
fi

[ -n "$bg" ] || exit 0

if [ $perdesk ]
then
    # apply new background, set desktop to use it
    cset=`expr 1024 + $desk`
    $towm "ColorSet $cset Pixmap $rootbg"
    $towm "*FvwmBacker: Command (Desk $desk) colorset $cset"
else
    # apply new default background
    $towm "Colorset 1023 Pixmap $bg"
fi
