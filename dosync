#!/bin/sh

trace=set-x
sync=
[ "x$1" = x-s ] && { shift; sync=1; }

needhost amadeus@home || exit 1
ask "Is $HOST@$SYSTEMID up to date" || exit 1

$trace \
pfx work:opt/redhat.x86.linux \
rsync -avHP --rsync-path='$HOME/scripts/rrsync kaper' /u/syncopt/redhat.x86.linux/HOME/. work:/cameron/opt-HOME/. &
[ $sync ] && wait

( # prepare the way
  $trace snarfaddrs &
  [ $sync ] && wait
  for subdir in scripts im \
		there/cs@zip.com.au/html \
		there/cskk.ezoshosting.com/html/cs \
		there/cskk.ezoshosting.com/html/cs/moto \
		there/adzapper.sourceforge.net/html
  do ( cd "$HOME/$subdir" || exit 1
       exec $trace myke _all
     ) &
     [ $sync ] && wait
  done
  wait
  $trace updsysscripts
)

# push real accounts
for w in @work @newt @jekyll @sf
do  $trace pfx "$w" syncstuff "$w" &
    [ $sync ] && wait
done

# push stub accounts
for who in cameron2@alpha cameron2@janus
do  $trace pfx "$who" syncsmall "$who" &
    [ $sync ] && wait
done

$trace pfx sf syncsf &
[ $sync ] && wait
$trace pfx ezos syncezos &
[ $sync ] && wait
$trace pfx zip synczip &
[ $sync ] && wait

wait
