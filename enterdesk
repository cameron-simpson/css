#!/bin/sh -u
#
# Operations to perform when entering a desktop.
#	- Cameron Simpson <cs@zip.com.au> 24mar2003
#

: ${LOGDIR:=$HOME/var/log}

exec </dev/null
exec >>$LOGDIR/console
exec 2>&1

##echo "[$0 $*]"
trace=	##set-x

force=
thisdesk=

[ $# -gt 0 ] && [ "x$1" = x-f ] && { force=1; shift; }
[ $# = 0 ] || { thisdesk=$1; shift; }

lastdesk=`currentdesk` || exit 1
[ -n "$thisdesk" ] || thisdesk=$lastdesk

if [ "x$thisdesk" = "x$lastdesk" ]
then
  [ $force ] || exit 0
else
  currentdesk "$thisdesk"
fi

(
  menubg=`desktop "$thisdesk" menubg-pngof` || menubg=
  if [ -z "$menubg" ]
  then
    menubg=`desktop "$thisdesk" menubg` || menubg=
    [ -n "$menubg" ] && menubg=`pngof "$menubg"` && ( $trace desktop "$thisdesk" menubg-pngof "$menubg" & )
  fi

  if [ -n "$menubg" ]
  then $trace fvwmcmd "Colorset 2 AspectPixmap $menubg"
  else $trace fvwmcmd 'Colorset 2 RootTransparent'
  fi

  $trace desktop "$thisdesk" wmcmds | fvwmcmd

  $trace desktop "$thisdesk" shcmds | sh -x &

  deskjob=`deskjob -d "$thisdesk"`
  case "$deskjob" in
    ''|.|idle)	;;
    *)		$trace job "$deskjob" ;;
  esac
) &

exit 0
