#!/bin/sh
#
# Examine the named files and attach correct extensions to misnamed ones.
#	- Cameron Simpson <cs@zip.com.au> 22feb1999
#
# Base entirely on file2mime and mimeext now. - cameron 24jul2003
#

[ $# = 0 ] && { [ -t 0 ] && echo "reading filenames from stdin..." >&2; set -- `cat`; }

xit=0

for f
do
    [ -f "$f" ] || { echo "$cmd: $f: not a regular file" >&2
		     xit=1; continue;
		   }
    [ -s "$f" ] || { echo "$cmd: $f: empty file!" >&2
		     xit=1; continue;
		   }

    type=`file2mime "$f"` || { echo "$cmd: can't deduce MIME type of \"$f\"" >&2
			       xit=1
			       continue
			     }

    prefext=`mimeext "$type"` || { echo "$cmd: no preferred extension for $type" >&2
				   xit=1
				   continue
				 }

    # see if ext is ok already
    fbase=`basename "$f"`
    case "$fbase" in
      *".$prefext")	[ -t 1 ] || echo "$f"; continue ;;
    esac

    fdir=`dirname "$f"`
    case "$fdir" in
	.)	fdir= ;;
	*)	fdir=$fdir/ ;;
    esac

    case $f in
	*.*)	newf=$fdir`expr "x$fbase" : 'x\(.*\)\..*'`.$prefext ;;
	*)	newf=$fdir$fbase.$prefext ;;
    esac

    [ -t 1 ] && echo "$f -> $newf"
    mv -i -- "$f" "$newf" || xit=1
    [ -t 1 ] || echo "$newf"
done

exit $xit
