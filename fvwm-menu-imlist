#!/bin/sh
#
# Generate menu for an image directory, with thumbnails.
#	- Cameron Simpson <cs@zip.com.au> 19oct2002
#

cmd=$0

##alert "#=$# $0 $*"
##exec 2>>$HOME/var/log/alert

##thsize=16x16
thsize=32x32

##alert "DFLT=[$FVWM_MENU_IMLIST_OP]"
##env|grep FVWM >>$HOME/var/log/alert
imop=${FVWM_MENU_IMLIST_OP:-"Exec xv"}

filelist=
inter=
dir=

usage="Usage: $cmd [-l filelist] [-o image-op] dir [files/dirs...]]"

badopts=

while :
do
  case $1 in
    -o) imop=$2; shift ;;
    -l)	filelist=$2; shift ;;
    --) shift; break ;;
    -?*)echo "$cmd: unrecognised option: $1">&2
	badopts=1
	;;
    *)	break ;;
  esac
  shift
done

if [ $# = 0 ]
then
    echo "$cmd: missindir dir" >&2
    badopts=1
else
    dir=$1; shift
    cd "$dir" || exit 1
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

if [ -n "$filelist" ]
then
    set x ${1+"$@"} `cat "$filelist"` || exit 1
    shift
else
    # no args? pick parent, subdirs, *.* (image files)
    [ $# = 0 ] && set .. */. *.*
fi

wd=`pwd`
thdir=.thumbnails/$thsize

thumblist=${TMPDIR:-/tmp}/imlist$$th

exec 3>"$thumblist"

##echo "entries=[$*]" >&2
for entry
do
    if [ -d "$entry/." ]
    then
      # directory pathname
      path=`cd "$entry" || exit 1; pwd` || continue

      # menu entry tag
      case "$entry" in
	  .|*/*)tag=`basename "$path"` ;;
	  *)	tag=$entry ;;
      esac

      ##alert "\"$tag\" PopImDir $path $imop"
      echo "\"$tag\" PopImDir $path $imop"
    else
      f=$entry
      [ -s "$f" ] || continue;

      case "$entry" in
	  $HOME/*)	tag='~/'`expr "x$entry" : "x$HOME/\\(.*\\)"` ;;
	  *)		tag=$entry ;;
      esac

      d=`dirname "$f"`
      case "$d" in
	  /*)	;;
	  *)	d=$wd/$d ;;
      esac
      case "$f" in
	  */*)	fbase=`basename "$f"` ;;
	  *)	fbase=$f ;;
      esac
      case "$f" in
	  /*)	;;
	  *)	f=$d/$fbase ;;
      esac

      case "$f" in
	  *.xpm|*.gif)
	      thfmt=xpm ;;
	  *.png|*.jpg)
	      thfmt=png ;;
	  *)  continue ;;
      esac

      ##echo "f=[$f] d=[$d]" >&2
      echo "$thfmt $f" >&3	# to the thumb maker ...

      thumb=$thdir/$fbase.$thfmt

      ##alert "\"%$d/$thumb%$tag\" Exec $imop $f"
      echo  "\"%$d/$thumb%$tag\" Exec $imop $f"
    fi
done

exec 1>&2

( renice +10 -p $$
  exec <"$thumblist"
  rm -f "$thumblist"
  while read thfmt f
  do
    d=`dirname "$f"`
    ( cd "$d" || exit 1
      [ -d "$thdir/." ] || mkdir -p "$thdir" || exit 1

      f=`basename "$f"`
      thumb=$thdir/$f.$thfmt
      [ -s "$thumb" ] && exit 0
      exec lock mkthumb "mk$thfmt" -o "$thumb" "$thsize" "$f"
    )
  done
) &
