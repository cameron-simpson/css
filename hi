#!/bin/sh
#
# The good morning stuff.	- Cameron Simpson <cs@zip.com.au>
#

cmd=`basename "$0"`
hi=$HOME/rc/hi

eval `datevars`
weekly=
mode=normal
noop=

[ "x$wdayname" = xMon ] && weekly=1
[ "x$1" = x-html ] && { mode=html; shift; }
[ "x$1" = x-normal ] && { mode=normal; shift; }
[ "x$1" = x-w ] && { weekly=1; shift; }
[ "x$1" = x-n ] && { noop=1; shift; }

if [ $# = 0 ]
then
    set space science eco comics chores "$SYSTEMID" weather
    ## [ -n "$mode" ] || mode=html
    ## set rterm `cd "$hi" || exit 1
    ##     ls -d [a-z]*|sed -e '/^cvs$/d' -e '/^Mykefile$/d' -e 's/\.weekly$//'|sort -u`
    ## shift
else
    [ -n "$mode" ] || mode=normal
fi

urllist=/tmp/hi-urls.$$

exec 4>&1
while [ $# -gt 0 ]
do
  task=$1; shift
  case "$task" in
      /*)	task=`expr "x$task" : 'x/\(.*[^/]\)/*$'`
	      echo "# $task" >&3
	      cat "$hi/"[a-z]* | egrep "$task" >&3
	      ;;
      *)	sfxs=; [ $weekly ] && sfxs="$sfxs .weekly"
	      for sfx in '' $sfxs
	      do  for f in "$hi/$task$sfx" "$hi/$task-"*".$sfx"
		  do  [ -s "$f" ] && cat "$f" >&3
		  done
	      done
	      ;;
  esac
done 3>&1 1>&4 4>&- \
| grep '^[^#]' \
| while read url grep
  do  if [ -z "$grep" ]
      then  us "$url"
      else  echo "$url" >&2
	    pageurls -i "$url" \
	    | egrep -i "$grep" \
	    | sort -u \
	    | ( hit=
		while read gurl
		do  xvurl -f "$gurl" >/dev/null &
		    ( cd $HOME/4h/im/comics || exit 1
		      exec httpget "$gurl"
		    ) &
		    echo "$gurl" >&2
		    hit=1
		done
		[ $hit ] || { echo "no hits grepping $url for \"$grep\"" >&2
			      us "$url"
			    }
	      )
      fi &
  done
