#!/bin/sh
#
# The good morning stuff.	- Cameron Simpson <cs@zip.com.au>
#

cmd=`basename "$0"`
hi=$HOME/rc/hi

eval `datevars`
weekly=
mode=

[ "x$wdayname" = xMon ] && weekly=1
[ "x$1" = x-html ] && { mode=html; shift; }
[ "x$1" = x-normal ] && { mode=normal; shift; }
[ "x$1" = x-w ] && { weekly=1; shift; }

if [ $# = 0 ]
then
    [ -n "$mode" ] || mode=html
    set rterm `cd "$hi" || exit 1
	       ls -d [a-z]*|sed -e '/^cvs$/d' -e '/^Mykefile$/d' -e 's/\.weekly$//'|sort -u`
    shift
else
    [ -n "$mode" ] || mode=normal
fi

urllist=/tmp/hi-urls.$$

( exec 4>&1
  while [ $# -gt 0 ]
  do
    task=$1; shift
    case "$task" in
	rterm)	case $HOST@$SYSTEMID in
		    zapff@cisra)	hosts='elph wanda' ;;
		    amadeus@home)	hosts='work janus' ;;
		    *)			hosts= ;;
		esac
		for h in $hosts
		do  lock -1 rterm-$h rterm $h &
		done
		;;
	/*)	task=`expr "x$task" : 'x/\(.*[^/]\)/*$'`
		echo "# $task" >&3
		cat "$hi/"[a-z]* | egrep "$task" >&3
		;;
	*)	if [ -f "$hi/$task" -o -f "$hi/$task.weekly" ]
		then
		    echo "# $task" >&3
		    [ -s "$hi/$task" ] && cat "$hi/$task" >&3
		    [ $weekly ] && [ -s "$hi/$task.weekly" ] && cat "$hi/$task.weekly" >&3
		else
		    echo "$cmd: $task: unknown task" >&2
		fi
		;;
    esac
  done 3>&1 1>&4 4>&- \
| grep '^[^#]' \
| while read url grep
  do  if [ -z "$grep" ]
      then  echo "$url"
      else  pageurls -i "$url" | grep "$grep"
      fi
  done >>"$urllist"
)

wait

case $mode in
    normal)
	[ -f "$urllist" ] && { grep '^[^#]' <"$urllist" | us -; rm "$urllist"; }
	;;
    html)
	html=$HOME/tmp/hi.html
	{ echo "<TITLE>hi for `daycode`</TITLE>"
	  echo "<H1>hi for `daycode`</H1>"
	  inlist=
	  while read url
	  do
	    case "$url" in
	      \#*)
		title=`expr "x$url" : 'x# *\(.*\)'`
		[ $inlist ] && { echo "</UL>"; inlist=; }
		echo "<H2>$title</H2>"
		;;
	      *)
		[ $inlist ] || { echo "<UL>"; inlist=1; }
		echo "<LI><A HREF=\"$url\">$url</A>"
		;;
	    esac
	  done
	  [ $inlist ] && { echo "</UL>"; inlist=; }
	} <"$urllist" >"$html"
	us "file:$html"
	;;
esac
