#!/bin/sh
#
# Simple jukebox.
# Runs a player in the background, reads keyword selections and commands
# in the foreground.
#	- Cameron Simpson <cs@zip.com.au> 01jun2002
#

playcopy=

cmd=`basename "$0"`
usage="Usage: $cmd [-C]"

[ "x$1" = x-C ] && { playcopy=1; shift; }

playpid=

runplayer()
{
  ( ok=1
    subproc=
    tmpauf=
    trap 'ok=; [ -n "$subproc" ] && kill $subproc; exit' 1 2 3 15
    trap '[ -n "$subproc" ] && kill $subproc' USR1
    playlist=/tmp/$cmd.$$
    while [ $ok ]
    do
	aulist -r $ptns >"$playlist"
	exec <"$playlist"
	rm -f "$playlist"
	while [ $ok ] && read -r auf
	do
	    if [ $playcopy ]
	    then
		tmpauf=${TMPDIR:-/tmp}/$cmd$$`basename "$auf"`
		(set -x; cp "$auf" "$tmpauf") && auf=$tmpauf
	    fi
	    case "$auf" in
	      *.ogg)	ogg123 -d oss "$auf" & ;;
	      *.mp3)	mpg123 -b 2048 "$auf" & ;;
	      *)	echo "$cmd: how to play $auf ?" >&2
			continue
			;;
	    esac
	    subproc=$!
	    wait
	    [ $playcopy ] && rm -f "$tmpauf"
	    [ $ok ] && sleep 2
	    subproc=
	done
    done
  ) &
  playpid=$!
}

stopplayer()
{ [ -n "$playpid" ] && { kill "$playpid"; playpid=; }
}

bumpplayer()
{ [ -n "$playpid" ] && { kill -USR1 "$playpid"; }
}

line=
while lastline=$line
      read line
do  
    [ "x$line" = "x!!" ] && line=$lastline
    case "$line" in
	'')	bumpplayer
		;;
	-)	stopplayer
		;;
	.)	ptns=
		stopplayer
		sleep 2
		runplayer
		;;
	*)
		ptns=$line
		stopplayer
		sleep 2
		runplayer
		;;
    esac
done

stopplayer
