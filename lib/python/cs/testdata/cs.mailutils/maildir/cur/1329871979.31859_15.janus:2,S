Return-Path: <python-list-bounces+cs=zip.com.au@python.org>
Delivered-To: unknown
Received: from mail.zip.com.au (125.255.95.3) by janus.home with POP3-SSL; 08
  Feb 2012 03:45:02 -0000
Delivered-To: cs@zipworld.com.au
Received: from mailin3-syd3.pacific.net.au (mailin3-syd3.pacific.net.au [125.255.92.144])
	by mailstore2.syd.pacific.net.au (Postfix) with ESMTP id 816E46B37
	for <cs@zipworld.com.au>; Wed,  8 Feb 2012 14:43:28 +1100 (EST)
Received: from mail.python.org (unknown [82.94.164.166])
	by mailin3-syd3.pacific.net.au (Postfix) with ESMTP id 6D36140008E
	for <cs@zip.com.au>; Wed,  8 Feb 2012 14:45:34 +1100 (EST)
Received: from albatross.python.org (localhost [127.0.0.1])
	by mail.python.org (Postfix) with ESMTP id 3TjT0722p1zN8g
	for <cs@zip.com.au>; Wed,  8 Feb 2012 04:43:19 +0100 (CET)
DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/simple; d=python.org; s=200901;
	t=1328672599; bh=R6oX+4OXvjHCyqm/JYadVKLbxM8zz5XwaidMO4f1l58=;
	h=Date:From:To:Subject:Message-ID:MIME-Version:In-Reply-To:
	 References:Cc:List-Id:List-Unsubscribe:List-Archive:List-Post:
	 List-Help:List-Subscribe:Content-Type:Content-Transfer-Encoding:
	 Sender;
	b=BnNnn4auuS9mpkxO9VlnCJJvp2JAH+4blo9whXfkTX9a9oL7D9fZXQ32DFfFPXaby
	 mtygpyKwgYMWHtVj76zeUkUwYgTWdMUDN0KPkT3MlPhraLm7nhODoL7RB0I1d7TTwL
	 4qvIAignX1h9WVQ3NtM+9AmvKx2b8yMOsAFRoL4w=
X-Original-To: python-list@python.org
Delivered-To: python-list@mail.python.org
Received: from albatross.python.org (localhost [127.0.0.1])
	by mail.python.org (Postfix) with ESMTP id 3TjSwz5wvFzMvP
	for <python-list@python.org>; Wed,  8 Feb 2012 04:40:35 +0100 (CET)
X-Spam-Status: OK 0.002
X-Spam-Evidence: '*H*': 1.00; '*S*': 0.00; 'socket': 0.04; 'app,':
	0.07; 'received:edu.au': 0.07; 'fetch': 0.09; 'throw': 0.09;
	'files.': 0.09; 'subject:python': 0.10; 'jeff': 0.13;
	'subject:file': 0.13; 'heavily': 0.15; 'appear.': 0.16;
	'appliance': 0.16; 'filenames': 0.16; 'from:addr:cs': 0.16;
	'from:addr:zip.com.au': 0.16; 'from:name:cameron simpson': 0.16;
	'incomplete': 0.16; 'message-id:@cskk.homeip.net': 0.16;
	'received:202.125.174': 0.16; 'received:202.125.174.133': 0.16;
	'received:boardofstudies.nsw.edu.au': 0.16;
	'received:cskk.homeip.net': 0.16;
	'received:harvey.boardofstudies.nsw.edu.au': 0.16;
	'received:homeip.net': 0.16; 'received:nsw.edu.au': 0.16; 'cc:addr
	:python-list': 0.16; '(i.e.': 0.17; 'wrote:': 0.18;
	'subject:skip:s 10': 0.18; 'cc:no real name:2**0': 0.21; 'file,':
	0.21; 'header:In-Reply-To:1': 0.22; 'runs': 0.23; 'django': 0.25;
	'performing': 0.26; 'cc:2**0': 0.26; 'random': 0.28; '(even':
	0.29; 'accessible': 0.29; 'problem': 0.29; 'cc:addr:python.org':
	0.29; 'server': 0.30; 'ftp': 0.32; "can't": 0.33; 'header:User-
	Agent:1': 0.33; 'file': 0.34; 'follows:': 0.34; 'record': 0.34;
	'(a)': 0.34; 'end.': 0.34; 'copying': 0.35; 'skip:" 20': 0.35;
	'actively': 0.36; 'received:au': 0.36; 'shows': 0.37; 'charset:us-
	ascii': 0.37; 'skip:" 10': 0.37; 'similar': 0.37; 'another': 0.37;
	'problems': 0.38; 'data': 0.38; 'sometimes': 0.38; 'open': 0.38;
	'files': 0.39; 'clearly': 0.39; 'format.': 0.39; 'client': 0.40;
	'change': 0.40; 'central': 0.62; 'high': 0.66; 'received:202':
	0.66; 'records': 0.74; 'acts': 0.77; 'cameron': 0.77; '_if_':
	0.84; 'incomplete.': 0.84; 'tricky': 0.84; 'from.': 0.93;
	'working,': 0.93; 'afford': 0.95
Received: from localhost (HELO mail.python.org) (127.0.0.1)
	by albatross.python.org with SMTP; 08 Feb 2012 04:40:35 +0100
Received: from harvey.boardofstudies.nsw.edu.au
	(mail2.rack1.boardofstudies.nsw.edu.au [202.125.174.133])
	by mail.python.org (Postfix) with ESMTP
	for <python-list@python.org>; Wed,  8 Feb 2012 04:40:35 +0100 (CET)
Received: from cskk.homeip.net (localhost.localdomain [127.0.0.1])
	by harvey.boardofstudies.nsw.edu.au (Postfix) with ESMTP id 659B44D3B67;
	Wed,  8 Feb 2012 14:40:25 +1100 (EST)
Received: by janus.cskk.homeip.net (Postfix, from userid 1000)
	id 4E790100419B7; Wed,  8 Feb 2012 14:40:25 +1100 (EST)
Date: Wed, 8 Feb 2012 14:40:25 +1100
From: Cameron Simpson <cs@zip.com.au>
To: silentnights <silentquote@gmail.com>
Subject: Re: python file synchronization
Message-ID: <20120208034025.GA14347@cskk.homeip.net>
MIME-Version: 1.0
Content-Disposition: inline
In-Reply-To: <24cb8965-9211-4601-b096-4bf482aead18@h6g2000yqk.googlegroups.com>
User-Agent: Mutt/1.5.21 (2010-09-15)
References: <24cb8965-9211-4601-b096-4bf482aead18@h6g2000yqk.googlegroups.com>
Cc: python-list@python.org
X-BeenThere: python-list@python.org
X-Mailman-Version: 2.1.12
Precedence: list
List-Id: General discussion list for the Python programming language
	<python-list.python.org>
List-Unsubscribe: <http://mail.python.org/mailman/options/python-list>,
	<mailto:python-list-request@python.org?subject=unsubscribe>
List-Archive: <http://mail.python.org/pipermail/python-list>
List-Post: <mailto:python-list@python.org>
List-Help: <mailto:python-list-request@python.org?subject=help>
List-Subscribe: <http://mail.python.org/mailman/listinfo/python-list>,
	<mailto:python-list-request@python.org?subject=subscribe>
Content-Type: text/plain; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Sender: python-list-bounces+cs=zip.com.au@python.org
Errors-To: python-list-bounces+cs=zip.com.au@python.org
X-Cats2Procmailrc-Rule: cats/home: python  python-list     sender:python-list-bounces+cs=zip.com.au@python.org
X-Label: python-list
Content-Length: 1873

On 07Feb2012 01:33, silentnights <silentquote@gmail.com> wrote:
| I have the following problem, I have an appliance (A) which generates
| records and write them into file (X), the appliance is accessible
| throw ftp from a server (B). I have another central server (C) that
| runs a Django App, that I need to get continuously the records from
| file (A).
| 
| The problems are as follows:
| 1. (A) is heavily writing to the file, so copying the file will result
| of uncompleted line at the end.
| 2. I have many (A)s and (B)s  that I need to get the data from.
| 3. I can't afford losing any records from file (X)
[...]
| The above is implemented and working, the problem is that It required
| so many syncs and has a high overhead and It's hard to debug.

Yep.

I would change the file discipline. Accept that FTP is slow and has no
locking. Accept that reading records from an actively growing file is
often tricky and sometimes impossible depending on the record format.
So don't. Hand off completed files regularly and keep the incomplete
file small.

Have (A) write records to a file whose name clearly shows the file to be
incomplete. Eg "data.new". Every so often (even once a second), _if_ the
file is not empty: close it, _rename_ to "data.timestamp" or
"data.sequence-number", open a new "data.new" for new records. 

Have the FTP client fetch only the completed files.

You can perform a similar effort for the socket daemon: look only for
completed data files. Reading the filenames from a directory is very
fast if you don't stat() them (i.e. just os.listdir). Just open and scan
any new files that appear.

That would be my first cut.
-- 
Cameron Simpson <cs@zip.com.au> DoD#743
http://www.cskk.ezoshosting.com/cs/

Performing random acts of moral ambiguity.
        - Jeff Miller <jxmill2@gonix.com>
-- 
http://mail.python.org/mailman/listinfo/python-list
