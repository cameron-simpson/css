#!/bin/sh
#
# Run and log a script session.
#	- Cameron Simpson <cs@zip.com.au> 18may2002
#

cmd=`basename "$0"`
usage="Usage: $cmd [-m msg] [-d logdir] logbase [{-c shcmd | cmd [args...]}]"

: ${LOGDIR:=$HOME/var/log}
: ${SHELL:=/bin/sh}

logdir=$LOGDIR/sessions

badopts=

while :
do
  case "$1" in
    -d)	logdir=$2; shift ;;
    -m)	msg=$2; shift ;;
    --)	shift; break ;;
    -?*)echo "$cmd: unrecognised option: $1" >&2; badopts=1 ;;
    *)	break ;;
  esac
  shift
done

if [ $# = 0 ]
then
  echo "$cmd: missing logbase" >&2
  badopts=1
else
  logbase=$1; shift

  if [ $# -gt 0 ]
  then
    if [ "x$1" = x-c ]
    then
	# convert -c into explicit command
	shcmd=$2; shift; shift
	[ $# = 0 ] || { echo "$cmd: extra arguments after \"-c shcmd\": $*" >&2
			badopts=1
		      }
	set -- "$SHELL" -c "$shcmd"
    fi
  fi
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

[ -z "$BUGSYSTEMS" ] \
|| [ -n "$msg" ] \
|| msg=`readbugline` \
|| { echo "$cmd: empty message rejected" >&2; exit 1; }
echo "msg=[$msg]" >&2

# we only need popSHELL if specific command supplied
if [ $# -gt 0 ]
then
  # adjust to full path of popSHELL because script uses execve, not execvep
  popSHELL=$SHELL
  popSHELLcmd=
  popSHELLpath=
  for d in `dirname "$0"` /opt/css/bin $HOME/scripts
  do  [ -x "$d/popSHELL" ] && { popSHELLpath=$d/popSHELL; break; }
  done
  [ -n "$popSHELLpath" ] || { echo "$cmd: can't find popSHELL script" >&2; exit 1; }
fi

logfile=$logdir/$logbase-`datecode`
logdir=`dirname "$logfile"`
needdir "$logdir" || exit 1

# hideous hack to restore $SHELL inside script command
# because script, curse its negligent author, only runs $SHELL
# rather than an arbitrary command
if [ $# -gt 0 ]
then
    popSHELL=$SHELL
    popSHELLcmd=`shqstr "$@"`
    SHELL=$popSHELLpath
    export SHELL popSHELL popSHELLcmd
fi

{ echo
  echo "$HOST @ $SYSTEMID"
  date
  id
  echo
} >>"$logfile"

wd=`pwd|entilde`
[ -n "$popSHELLexec" ] && dlog "$HOST@$SYSTEMID: $wd: start $popSHELLexec" &
script -a "$logfile"
xit=$?
[ -n "$popSHELLexec" ] && dlog "$HOST@$SYSTEMID: $wd: end   $popSHELLexec" &

[ -n "$BUGSYSTEMS" ] && buglog "$msg" <"$logfile"
gzip -v -9 "$logfile"

exit $xit
