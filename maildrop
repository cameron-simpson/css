#!/bin/sh
#
# Queue mail for delivery.
#	- Cameron Simpson <cs@zip.com.au> 26sep1996
#
# Recoded in perl. - cameron, 07oct1994
# Added requeue facility. - cameron, 10oct1994
# Recoded in shell. - cameron, 26sep1996
#

mbox=+UNFILED
input=-
sync=1
verbose=
requeue=
qdir=$HOME/var/maildrop
fmlog=

cmd=`basename "$0"`
usage="Usage: $cmd [-s] [-v] [-f inputfile] [mailboxes...]
	-s		Synchronous.
	-v		Verbose.
	-f inputfile	Specify input file (default stdin).
	-F fmlog	Use fmlog as the filemail log.
	mailboxes	Where to file mail (default +in).
       $cmd [-v] -r [queued-files...]
	-r		Requeue."

badopts=
while :
do  case $1 in
	--)	shift; break ;;
	-s)	sync=1 ;;
	-v)	verbose=1 ;;
	-f)	input=$2; shift ;;
	-F)	fmlog=$2; shift ;;
	-r)	requeue=1 ;;
	-?*)	echo "$cmd: unrecognised option: $1" >&2
		badopts=1
		;;
	*)	break ;;
    esac
    shift
done

if [ -z "$requeue" ]
then
    if [ $# != 0 ]
    then	mbox=$*
    fi
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

if [ -n "$fmlog" ]; then logfilemail=$fmlog
		    else logfilemail=`logpath filemail`
fi

xit=0

if [ $requeue ]
then
    [ $# = 0 ] && { cd "$qdir" || exit $?; set x *.+*; shift; }
    pwd=`pwd`
    for f
    do  case $f in
	    /*/*)	bf=`basename "$f"` F=$f ;;
	    */*)	bf=`basename "$f"` F=$pwd/$f ;;
	    *)		bf=$f F=$pwd/$f ;;
	esac

	[ -d "$F/." ] && { echo "$cmd: can't file directories, skipping $F" >&2
			   xit=1
			   continue
			 }

	case "$bf" in
	    *.+*)	mbox=+`expr "x$f" : 'x.*\.+\(.*\)'|tr , ' '` ;;
	    *)		mbox=+in ;;
	esac
	case "$logfilemail" in
	    -)	echo "$F $mbox" ;;
	    *)	echo "$F $mbox" >>"$logfilemail" ;;
	esac
    done
else
    tmp=$qdir/`datecode`.$HOSTNAME.$$.`echo "$mbox"|sed 's/ /,/g'`
    [ $verbose ] && echo "saving to $tmp ..." >&2
    if [ ! -f "$tmp" ] && cat >"$tmp"
    then	echo "$tmp $mbox" >>"$logfilemail"
    else	xit=$?
    fi
fi

exit $xit
