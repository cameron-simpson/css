#!/bin/sh
#
# Change the image menu backdrop image for the running FVWM.
#	- Cameron Simpson <cs@zip.com.au> 18oct2002
#

cmd=`basename "$0"`
call="$0 $*"

domenu=
aspect=-t
strippfx=
pickn=1
thisdesk= Dflag=

usage="Usage: $cmd [-M] [ imagefile | bglist-args... ]
	-t	Choose tall images.
	-w	Choose wider images.
	-D	Set the menu backdrop only for this desktop.
	-M	Popup FVWM menu to pick from choices."

badopts=
opts=

while :
do
  case $1 in
    -D)	opts="$opts $1" thisdesk=1 Dflag=$1 ;;
    -M)	opts="$opts $1" pickn=20 domenu=1 strippfx=$HOME ;;
    -[tw]) aspect=$1 ;;
    -?*)echo "$cmd: unrecognised option: $1" >&2; badopts=1 ;;
    --)	shift; break ;;
    *)	break ;;
  esac
  shift
done

[ $badopts ] && { echo "$usage" >&2; exit 2; }

if [ "x$*" = xnone ]
then
    exec fvwmcmd 'ColorSet 2 RootTransparent buffer, Tint black 30'
fi

##set -x
if [ $# = 1 -a -f "$1" -a -s "$1" ]
then
    # one argument which is a file pathname
    domenu=
else
    case "$#,$1" in
      1,http://*)
	# one argument which is a URL
	exec withurl -C "$1" "$0"
	;;
    esac

    # presume search args instead
    set x `pickim -P "$strippfx" -n $pickn -r $aspect ${1+"$@"} | sort -u` || exit 1
    shift
    [ $# = 0 ] && { echo "$cmd: no image files chosen!" >&2; exit 1; }
    if [ -t 1 ]; then  cd; ls -ld "$@"; fi &
    [ $# = 1 ] && domenu=
fi

##set +x
##echo "*=[$*]" >&2

if [ $domenu ]
then
    tmpf=/tmp/menubg$$
    for arg
    do  echo "$arg"
    done >"$tmpf"
    fvwmcmd \
	  "SetEnv FVWM_MENU_IMLIST_OP \"menubg $opts\"" \
	  "Piperead 'fvwm-menu -1 ImDirMenu \"$cmd $call\" fvwm-menu-imlist -l $tmpf .; rm $tmpf'" \
	  "Popup ImDirMenu" \
	  "UnSetEnv FVWM_MENU_IMLIST_OP"
    exit $?
fi

imagefile=$1

( lastvalue menubg "$imagefile"
  if [ $thisdesk ]
  then  thisdesk=`lastvalue "enterdesk-$HOST"`
	desktop "$thisdesk" menubg "$imagefile"
  else  lastvalue "defaultmenubg-$HOST" "$imagefile"
  fi
) &

setpix()
{ dorm=
  [ "x$1" = x-r ] && { dorm=1; shift; }
  setpic=$1; shift
  L "$setpic"
  set "ColorSet 2 Tint rgb:00/00/20 50, TiledPixmap \"$setpic\""
  set -x
  fvwmcmd "$@"
  [ $dorm ] && fvwmcmd "Exec rm -rf \"$setpic\""
}

case "$bright,$imagefile" in
    *.png|*.xpm)
	# no format conversion needed
	setpix "$imagefile"
	exit $?
	;;
esac

tmpf=${TMPDIR:-/tmp}/$cmd$$.png
gm convert - -geometry '200x>' png:- <"$imagefile" >"$tmpf" || exit 1

set -x
setpix -r "$tmpf"
