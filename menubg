#!/bin/sh
#
# Change the image menu backdrop image for the running FVWM.
#	- Cameron Simpson <cs@zip.com.au> 18oct2002
#

cmd=$0
call="$0 $*"

domenu=
aspect=-t
strippfx=
geom=300x600
pickn=1

usage="Usage: $cmd [-M] [XxY] [ imagefile | bglist-args... ]
	-M	Popup FVWM menu to pick from choices.
	XxY	Max XxY geometry of scaled image. Default: $geom"

badopts=

[ "x$1" = x-M ] && { pickn=20 aspect= domenu=1 strippfx=$HOME; shift; }

case "$1" in
    [1-9]*x[1-9]*)
	geom=$1; shift ;;
esac

[ $badopts ] && { echo "$usage" >&2; exit 2; }

if [ $# = 1 -a -f "$1" -a -s "$1" ]
then
    :
else
    set x `set -x; pickim -P "$strippfx" -n $pickn -r $aspect ${1+"$@"} | sort -u` || exit 1
    shift
    [ $# = 0 ] && exit 1
    [ $# = 1 ] && domenu=
fi

##echo "*=[$*]" >&2

if [ $domenu ]
then
    tmpf=/tmp/menubg$$
    for arg
    do  echo "$arg"
    done >"$tmpf"
    fvwmcmd \
	  "Piperead 'fvwm-menu -1 ImDirMenu \"$cmd $call\" fvwm-menu-imlist -o menubg -l $tmpf .; rm $tmpf'" \
	  "Popup ImDirMenu"
    exit $?
fi

imagefile=$1

setpix()
{ dorm=
  [ "x$1" = x-r ] && { dorm=1; shift; rmwhat=$1; shift; }
  set "ColorSet 2 Tint rgb:00/00/20 50, AspectPixmap \"$1\""
  fvwmcmd "$@"
  [ dorm ] && fvwmcmd "Exec rm -rf \"$rmwhat\""
}

case "$bright,$imagefile" in
    *.png|*.xpm)
	# no format conversion needed
	setpix "$imagefile"
	exit $?
	;;
esac

wkdir=`mkdirn "${TMPDIR:-/tmp}/menubg"` || exit 1

cp "$imagefile" "$wkdir/." || exit 1
lastvalue menubg "$imagefile"
echo "$imagefile" >>$HOME/var/log/menubg

cd "$wkdir"
imagefile=`basename "$imagefile"`
impng=`echo "$imagefile" | sed 's/\\(.*\\.\)[^.]*$/\\1PNG/'`

##mogrify -geometry "$geom" -modulate 70 -despeckle -format PNG "$imagefile"
if /opt/ImageMagick/bin/mogrify -format PNG "$imagefile"
then
    # horrible workaround for mogrify bug
    rm -f "$imagefile"
    mv ./* "$impng"
    setpix -r "$wkdir" "$wkdir/$impng"
else
    L "$wkdir" >&2
    exit 1
fi
