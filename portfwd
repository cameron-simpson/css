#!/bin/sh
#
# Arrange forwarding of the usual ports.
#	- Cameron Simpson <cs@zip.com.au> 15apr1999
#

cmd=`basename "$0"`
usage="Usage: $cmd [-v] [-x] [host=addr...] [from2to...]"

### make a fresh ssh-agent
##if [ -t 0 -a -t 1 ]
##then
##    trap '' 1
##    eval `ssh-agent -k -s`
##    eval `ssh-agent -s`
##    ssh-add
##fi

home=home
zip=zip
cisra=cisra

vflag=
trace=

badopts=
while :
do  case "$1" in
	-x)	trace=set-x ;;
        -v)	vflag=-v ;;
	--)	shift; break ;;
	-?*)	echo "$cmd: unrecognised option: $1" >&2
		badopts=1
		;;
	home=*|zip=*|cisra=*)
		eval "$1"
		;;
	*=*)	echo "$cmd: unknown host=*; I know home, zip and cisra" >&2
		badopts=1
		;;
	*)	break ;;
    esac
    shift
done

if [ $# = 0 ]
then
    case "$HOST@$SYSTEMID" in
	zapff@cisra)	set cisra2zip cisra2home nntpcached ;;
	amadeus@home)	set home2cisra home2zip nntpcached ;;
	*)		echo "$cmd: no forwardings to do on $HOST@$SYSTEMID" >&2
			badopts=1
			;;
    esac
fi

[ $badopts ] && { echo "$usage" >&2; exit 2; }

DISPLAY=; export DISPLAY; unset DISPLAY

for fwd
do  case "$fwd" in
	zipnntp)
	    echo "forward $HOST:2119 to news.zip.com.au:119"
	    $trace \
	    alog zipnntp lock -1 fwd_zipnntp \
		tcpio -a 2119 need-ssh-agent -f ssh -x zip 'exec nc news.zip.com.au 119'
	    ;;
	nntpcached)
	    echo "setup nntpcached ..."
	    $trace \
	    rignntpcache
	    ;;
	cisra2zip)
	    echo "cisra2zip..."
	    $trace \
	    vpnssh $vflag -t 60 "$zip" \
		   -L 8081:localhost:8081 \
		   -L 9875:203.17.198.110:9875 \
		   -L 9876:203.17.198.107:9875 \
		   -L 2119:news:119 \
		   -L 2025:mail:25 \
		   -L 2080:proxy:8080 \
		   -L 2110:mail:110 &
	    ;;
	cisra2home)
	    echo "cisra2home..."
	    $trace \
	    vpnssh $vflag -t 60 -q "$home" \
		   -L 2111:mail-optus:110 \
		   -L 2180:www-optus:110 \
		   -L 2401:cvs-cskk:2401 \
		   -L 3316:amadeus:3306 \
		   -L 8880:amadeus:8880 \
		   -L 3119:news-optus:119 \
		   -L 5915:amadeus:5905 \
		   -L 5916:amadeus:5906 &
	    ;;
	home2zip)
	    echo "home2zip..."
	    $trace \
	    vpnssh $vflag "$zip" \
		   -L 8081:localhost:8081 \
		   -L 2119:news:119 \
		   -L 2025:mail:25 \
		   -L 2110:mail:110 &
	    ;;
	home2cisra)
	    echo "home2cisra..."
	    $trace \
	    vpnssh $vflag "$cisra" \
		   -L 2080:web:80 \
		   -L 2222:zapff:22 \
		   -L 3306:mysql:3306 \
		   -L 3316:mysql:3306 \
		   -L 5915:zapff:5905 \
		   -L 5916:zapff:5906 \
		   -L 5917:piaf:5900 &
	    ;;
##	del)
##	    echo "web@del ..."
##	    acon lock -1 web@del tcpio -a 2082 need-ssh-agent -f ssh del nc localhost 80
##	    ;;
	*)  echo "$cmd: unknown forwarding target \"$fwd\"" >&2
	    exit 1
	    ;;
    esac
done
