#!/bin/sh
#
# Set the root background, update state files to match.
#	- Cameron Simpson <cs@zip.com.au>
#

: ${TMPDIR:=/tmp}
: ${RBG_PICKIM:='-w -x "$HALFX" -y "$HALFY"'}
tmppfx=$TMPDIR/rbg$$
trap 'rm -f "$tmppfx".*' 0 1 15

cmd=$0
usage="Usage: $cmd [-1] [-d desk] [-n] [-xpl] [imlist-search-args...]
	-1	Choose exactly one image.
	-d desk	Set the background for the specified desk.
		Default: the global backdrop.
	-n	No action. Just print the chosen image(s).
	-xpl	Xplanet mode. Arguments are passed to xpl, not imlist-search."

[ -n "$DISPLAY" ] || { echo "$cmd: no \$DISPLAY!" >&2; exit 1; }

badopts=

pickn=20
perdesk=
pickopts=
strippfx=
bgdesk=-
doxpl=
doit=1

while :
do  case $1 in
	-d)	bgdesk=$2; shift ;;
	-n)	doit= ;;
	-1)	pickn=1 ;;
	-xpl)	doxpl=1 ;;
	*)	break ;;
    esac
    shift
done

[ "x$bgdesk" = x. ] && bgdesk=`currentdesk`

if [ $doxpl ]
then
    bgdir=`mkdirn $HOME/var/cache/rbg/` || exit 1
    tmpim=$bgdir/rbg$$.png
    set -x
    xpl -1 -o "$tmpim" -g screen ${1+"$@"} \
    && deskbg -d "$bgdesk" "$tmpim"
    exit $?
fi

if [ $# = 1 ]
then
  case "$1" in
    http://* | ftp://* )
      exec withurl -C "$1" deskbg -d "$bgdesk"
      ;;
    X:* | 1,- | 1,*:- | 1,\|* )
      # one argument which is a GraphicsMagick-ish name
      exec deskbg -d "$bgdesk" "$1"
      ;;
  esac

  # a file?
  [ -f "$1" -a -s "$1" ] && exec deskbg -d "$bgdesk" "$1"
fi

tmpf=$tmppfx.txt
eval "pickim -P \"\$strippfx\" -n \"\$pickn\" -w -x \"\$HALFX\" -y \"\$HALFY\" $RBG_PICKIM "'${1+"$@"}' | sort -u >"$tmpf"
[ -s "$tmpf" ] || { echo "$cmd: no image files chosen!" >&2
		    exit 1
		  }

[ $doit ] || { cat "$tmpf"; exit $?; }	## no exec so trap may run

# pop up menu choice
{ echo "DestroyMenu RBGMenu"
  echo "AddToMenu RBGMenu \"Set Root BG: deskbg -d $bgdesk\" Title"
  fvwm-menu-imlist -l - RBGMenu deskbg -d "$bgdesk"
  echo "Popup RBGMenu"
} \
<"$tmpf" \
| tee -a "$CONSOLE" | fvwmcmd
