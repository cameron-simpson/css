Big refactor to use cs.hashindex for the content checks and better internal data structures.
