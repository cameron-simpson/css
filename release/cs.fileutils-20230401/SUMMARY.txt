Replaced a lot of runstate plumbing with @uses_runstate.
