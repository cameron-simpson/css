Rename _state to state, making it public.
Some other internal changes.
