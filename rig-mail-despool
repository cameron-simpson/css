#!/bin/sh -ue

cmd=`basename "$0"`
usage="Usage: $cmd [spoolnames..."

: ${MAILDIR:=$HOME/mail}

delay=5
timeout=60

[ $# -gt 0 ] || set -- spool spool-in spool-out spool-xref ham spam-definite

xit=0

for spool
do
  case $spool in
    ./* | ../* | /* )   maildir=$spool ;;
    *)                  maildir=$MAILDIR/$spool ;;
  esac
  case $spool in
    */*)                flatspool=`printf "%s\n" "$spool" | tr / _` ;;
    *)                  flatspool=$spool ;;
  esac
  set -- bgproc -l procmail -p "mail-despool-$flatspool" -- set-x lock -1 "$maildir" nice nice mail-despool -d "$delay" -t "$timeout" "$maildir"
  if locked "$maildir"
  then
    echo "$cmd: lock $maildir taken: skipping: $*" >&2
  else
    "$@" || xit=1
  fi
done

exit $xit
