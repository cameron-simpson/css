#!/bin/sh
#
# Set up an ssh-agent in daemon mode.
#	- Cameron Simpson <cs@zip.com.au> 30jul2001
#

cmd=$0
usage="Usage: $cmd [-u] [statefile]"

statefile=
unlock=

badopts=

[ "x$1" = x-u ] && { unlock=1; shift; }

[ $# = 0 ] || { statefile=$1; shift; }

[ $# = 0 ] || { echo "$cmd: extra arguments: $*" >&2; badopts=1; }

[ $badopts ] && { echo "$usage" >&2; exit 2; }

[ -n "$statefile" ] || statefile=`ssh-agent-statefile` || exit 1

# force unlock
[ $unlock ] && ( set -x; unlock -f "$statefile" )

export statefile

exec \
  lock -1 -a "$statefile" \
  rmthen -f "$statefile" \
  no-ssh-agent \
  set-x \
  ssh-agent \
  sh -c 'stash-ssh-agent "$statefile"; exec pause' \
  </dev/null
