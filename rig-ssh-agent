#!/bin/sh -u
#
# Set up a per-host ssh-agent in daemon mode if needed.
#	- Cameron Simpson <cs@zip.com.au> 30jul2001
#

cmd=$0
usage="Usage: $cmd [statefile]"

statefile=
badopts=

while [ $# - gt 0 ]
do
  case $1 in
    --) shift; break ;;
    -?*)echo "$cmd: unrecognised option: $1" >&2
        badopts=1
        ;;
    *)  break ;;
  esac
  shift
done

[ $# = 0 ] || { statefile=$1; shift; }
[ $# = 0 ] || { echo "$cmd: extra arguments: $*" >&2; badopts=1; }

[ $badopts ] && { echo "$usage" >&2; exit 2; }

[ -n "$statefile" ] || statefile=`ssh-agent-statefile` || exit 1
eval `get-ssh-agent "$statefile" || echo false` && exit 0

export statefile
exec \
  bgproc \
  rmthen -f "$statefile" \
  no-ssh-agent \
  set-x \
  ssh-agent \
  sh -c 'stash-ssh-agent "$statefile"; exec pause' \
  </dev/null
