#!/bin/sh
#
# Dispatch a daemon mode fetchmail.
#	- Cameron Simpson <cs@zip.com.au> 14dec2003
#

: ${LOGDIR:=$HOME/var/log}

needhost $HOMEHOST@home || exit 1
cd
( fmopts=
  fmdelay=300
  fmhosts='optus.local zip.local'
  case "$LOCATION" in
    cisra|home) ;;
    *) fmopts="$fmopts -l 65536" fmdelay=900 ;;
  esac
  set -- -f "$HOME/.fetchmailrc" \
	  -t 1800 \
	  --logfile "$LOGDIR/fetchmail" \
	  --nobounce --tracepolls --warnings 86400
  (
    set -x

    # fetch and file small items
    fetchmail "$@" $fmopts -l 65536 $fmhosts
    lock -1 getmail-despool getmail-flush spool

    # dispatch daemons to regularly fetch and file
    alog procmail lock -1 getmail-despool nice getmail-flush -p 30 spool
    acon fetchmail "$@" -d "$fmdelay" $fmopts $fmhosts
  ) &
)
