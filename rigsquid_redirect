#!/bin/sh -u
#
# Dispatch my squid - generally runs an adzapper.
#	- Cameron Simpson <cs@zip.com.au> 01jul2004
#

: ${VARRUN:=$HOME/var/run}

cmd=$0
usage="Usage: $cmd [-f] [peers]"

trace=set-x

force=
[ $# -gt 0 ] && [ "x$1" = x-f ] && { force=1; shift; }

[ $# = 0 ] || { SQUID_PEERS=$*; export SQUID_PEERS; }

$trace killpidfile -w squid.pid

## old proxy-mode standalone redirector
##exec alog squid_redirect squid_redirect -P "8080:$SQUID"

rc=$HOME/tmp/squid.conf
pidf=$VARRUN/squid.pid

env SQUID_PIDFILE=$pidf envsub -p '\{\{([A-Z]\w*)\}\}' <"$HOME/rc/squid/tplt" >"$rc"
mksquidpeers >>"$rc"

bsed -s '/^$/d; /^#/d' "$rc"
cat "$rc"
exec $trace alog squid/cache.log squid -f "$rc" -D
