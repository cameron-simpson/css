#!/bin/sh
#
# Set the root backdrop.
#	- Cameron Simpson <cs@zip.com.au> 20nov2000
#
# -xpl for xplanet support - cameron 30nov2000
#

cmd=$0
usage="Usage: $0 [-s] [-d dim] [-xpl] [{imagefile|ptns...}]"

[ -n "$DISPLAY" ] || { echo "$cmd: no \$DISPLAY!" >&2; exit 1; }

sync=
xplanet=
convopts='-d 0.6'

badopts=
while :
do  case $1 in
        -xpl)	xplanet=1 ;;
	-s)	sync=1 ;;
	-d)	convopts="$convopts -d $2"; shift ;;
	--)	shift; break ;;
	-?*)	echo "$cmd: unrecognised option: $1" >&2
		badopts=1
		;;
	*)	break ;;
    esac
    shift
done

[ $badopts ] && { echo "$usgae" >&2; exit 2; }

if [ $# -gt 0 ] && [ -s "$1" ] && [ ! -d "$1/." ]
then
    imagefile=$1; shift
else
    # note: -n 20 followed by pickn because -w happens _after_ -n
    imagefile=`BGPATH=$WALLPAPER bglist -r -n 20 -w ${1+"$@"} | pickn`
    [ -n "$imagefile" ] && [ -s "$imagefile" ] || exec xsetroot -solid black
fi

if [ $xplanet ]
then
    imdir=$HOME/etc/im
    backdrop=$imagefile
    projdir=$imdir/projections
    clouddir=$projdir
    clouds=$clouddir/clouds_2000.jpg
    ssecclouds=$clouddir/latest_moll.gif
    nightside=$projdir/earthlights-dmsp-big.jpg
    dayside=$projdir/earth-2400.jpg

    # pick a view on the Sydney side of the planet
    lat=`tzcoord.pl Sydney | perl -e '$_=<STDIN>; /^([^.]+)/ || die; srand((time^$$)+getppid()); print int($1-89.5+rand(180))'`

    ## -demfile "$dem" -grid
    ## -cloud_ssec "$ssecclouds" \
    nice xplanet \
	    -background "$backdrop" \
	    -blend \
	    -cloud_image "$clouds" \
	    -image "$dayside" \
	    -label -labelpos -15-15 \
	    -markers \
	    -night_image "$nightside" \
	    -observer "$lat,0" \
	    -radius 40 \
	    -root \
	    ${1+"$@"} \
	    &

    exit 0
fi

case "$imagefile" in
    *.gif|*.xpm)	2xpm -s root $convopts "$imagefile" xpmroot & ;;
    *)			2png -s root $convopts "$imagefile" display -window root & ;;
esac

[ $sync ] || exit 0
wait
