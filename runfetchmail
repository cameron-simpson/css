#!/bin/sh
#
# Run a regular fetchmail. Pulled from rigfetchmail.
#	- Cameron Simpson <cs@zip.com.au> 31dec2003
#

: ${LOGDIR:=$HOME/var/log}
: ${VARRUN:=$HOME/var/run}

once=
trace=set-x
idledelay=1800
expunge=512
logfile=$LOGDIR/fetchmail

cmd=$0
usage="Usage: $cmd [-1] [fetchmail-options...]"

[ "x$1" = x-1 ] && { once=1; shift; }

while :
do
  mypid=$$
  eval "`syncenv $mypid`"

  fmopts=
  fmdelay=300
  fmhosts=${RUNFETCHMAIL_HOSTS:-'optus.local zip.local'}
  case "$LOCATION" in
    cisra)	;;
    home)	fmopts="$fmopts -l 128000" ;;
    *)		fmopts="$fmopts -l 65536" fmdelay=900 ;;
  esac
  necho `date`': ' >&2
  $trace \
  fetchmail \
	-f "$HOME/.fetchmailrc" \
	-t "$idledelay" \
	-e "$expunge" \
	--logfile "$logfile" \
	--nobounce --tracepolls --warnings 86400 \
	$fmopts $RUNFETCHMAIL_FMOPTS ${1+"$@"} $fmhosts
  echo `date`: fetchmail done | tee -a "$logfile" >&2
  killpidfile getmail_flush.pid

  [ $once ] && break
  bgproc -s -p fetchmail_sleep.pid sleep $fmdelay
done
