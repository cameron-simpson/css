#!/usr/bin/perl
#
# Take a fontised string as appears in Subject: lines and attachment descriptions
# and convert it to raw form.
#	- Cameron Simpson <cs@zip.com.au> 01feb2002
#

($::cmd=$0) =~ s:.*/::;

if (@ARGV)
{ for my $arg (@ARGV)
  { $arg=unfontise($arg);
    print "$arg\n";
  }
}
else
{ my $arg = <STDIN>;
  die "$::cmd: expected string on stdin\n" if ! defined $arg;
  chomp($arg);

  $arg=unfontise($arg);
  print "$arg\n";
}

exit 0;

sub unfontise
{ local($_)=@_;

  my $dec = '';
  my $charset;
  my $enc;
  my $encwords;

  while (/=\?([^?]+)\?([QB])\?([^?]*)\?=/i)
  {
    ($charset,$enc,$encwords)=(uc($1),uc($2),$3);
    $dec.=$`;
    $_=$';

    if ($enc eq 'Q')
    { $encwords =~ tr/_/ /;
      $encwords =~ s/=([\da-f][\da-f])/eval "chr(0x$1)"/egi;
    }
    else
    { warn "$0: unsupported encoding: \"$enc\"";
    }

    $dec.=$encwords;
  }

  return $dec.$_;
}
