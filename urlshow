#!/bin/sh
#
# Display URLs with a browser.
#	- Cameron Simpson <cs@zip.com.au>
#
# Added netscape -remote support.	cameron, 05may1995
# Removed mosaic support.		cameron, 10nov1997
# Netscape takes multiple -remote()s!	cameron, 10nov1997
# Jamie Zawinski's <jwz@netscape.com> netscape-remote.c used instead. - cameron, 16mar1999
# support some meta prefixes.		cameron 28mar2000
# 

mode=netscape	# was mosaic
## NETSCAPE=${NETSCAPE-/opt/script/netscape}
NETSCAPE=netscape-remote

cmd=`basename "$0"`
usage="Usage: $cmd [-a] [-c] [-s] [-t] [-i file] [URLs...]
	-a	Anonymous.
	-c	Clean.
	-s	Same window - don't open a new browser window.
	-t	New tab, instead of new window.
	-i file	Read URLs from file; \"-\" means stdin."

subopts=
url=
mode=new-window
meta=
badopts=
while :
do  case "$1" in
	-[acst]) subopts="$subopts $1" ;;
    esac
    case $1 in
	-a)	meta="anon $meta" ;;
	-c)	meta="clean $meta" ;;
	-s)	mode= ;;
	-t)	mode=new-tab ;;
	-i)	input=$2; shift
		set x ${1+"$@"} "" `cat $input`; shift
		;;
	--)	shift; break ;;
	-?*)	echo "$cmd: $1: unrecognised option" >&2
		badopts=1
		;;
	*)	break ;;
    esac
    shift
done

[ $badopts ] && { echo "$usage" >&2; exit 1; }

[ -n "$mode" ] && mode=,$mode

[ -n "$url" ] && { set x "$url"; shift; }

if [ $anon ]; then anonpfx=http://anon.free.anonymizer.com/
              else anonpfx=
fi

if [ $# != 0 ]
then
    for url
    do  if [ "x$url" = x- ]
	then
	    cat
	else
	    echo "$url"
	fi
    done \
    | "$0" $subopts
    exit $?
fi

set x -noraise -iconic

sed -e 's/^[ 	][ 	]*//' \
    -e 's/^#.*//' \
    -e '/^$/d' \
    -e 's/^.*<\(.*\)>.*$/\1/' \
    -e 's/^.*(\(.*\)).*$/\1/' \
    -e 's/^[^a-z]*\([a-z][a-z]*:\/\/.*\)/\1/' \
    -e '/^[a-z][a-z]*:\/\//b ok' \
    -e '/^file:/b ok' \
    -e '/^news:/b ok' \
    -e 's/^/http:\/\//' \
    -e ':ok' \
| { while read url
    do  
	[ -n "$URLLOG" ] && echo "urlshow $url" >>"$URLLOG"

	url="$meta$url"
	metapfx=
	while :
	do  case "$url" in
	      search\ *|clean\ *|anon\ *)
		metacmd=`expr "x$url" : 'x\([^ ]*\) .*'`
		url=`expr "x$url" : 'x[^ ]*  *\(.*\)'`
		case $metacmd in
		  anon)	metapfx="http://anon.free.anonymizer.com/$metapfx" ;;
		  clean)metapfx="http://web/~cameron/cgi-bin/htclean.cgi/$metapfx" ;;
		  search)
			engine=`expr "x$url" : 'x\([^ ]*\) .*'`
			url="http://web/~cameron/cgi-bin/search.cgi?engine=$engine&query="`expr "x$url" : 'x[^ ]*  *\(.*\)'`
			;;
		  *)	echo "$cmd: bogus meta command \"$metacmd\"" >&2
			;;
		esac
		;;
	      *)break
		;;
	    esac
	done

	# escape stuff for OpenURL() call
	url=`echo "$url" | hexify`
	set "$@" -remote "OpenURL($metapfx$url$mode)"
    done
    shift	# toss x

    case $DISPLAY in
	:*)	id=$HOST$DISPLAY ;;
	*)	id=$DISPLAY ;;
    esac
    "$NETSCAPE" "$@" \
	|| { echo "FAILED request for $*" >&2; exit 1; }
  }
