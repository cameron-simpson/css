#!/bin/sh
#
# Display URLs with a browser.
#	- Cameron Simpson <cs@zip.com.au>
#
# Added netscape -remote support.	cameron, 05may1995
# Removed mosaic support.		cameron, 10nov1997
# Netscape takes multiple -remote()s!	cameron, 10nov1997
# Jamie Zawinski's <jwz@netscape.com> netscape-remote.c used instead. - cameron, 16mar1999
# support some meta prefixes.		cameron 28mar2000
# Switch to mozilla-xremote-client.	cameron 26aug2002
# 

: ${BROWSER_DISPLAY:=$DISPLAY}
: ${DISPLAY:=$BROWSER_DISPLAY}
export DISPLAY

cmd=`basename "$0"`
usage="Usage: $cmd [-a] [-c] [-d display] [-s] [-t] [-i file] [URLs...]
	-a	Anonymous.
	-c	Clean.
	+c	Don't clean.
	-p	Probe for running browser first.
	-t	Open a new tab instead of a new window.
	-i file	Read URLs from file; \"-\" means stdin."

doprobe=
subopts=
doclean=
doanon=
popnew=1
mozremote=/opt/firefox/mozilla-xremote-client

badopts=

while :
do  case "$1" in
	-[acst]) subopts="$subopts $1" ;;
    esac
    case $1 in
	-a)	doanon=1 ;;
	-c)	doclean=1 ;;
	+c)	doclean= ;;
	-d)	DISPLAY=$2; export DISPLAY; shift ;;
	-p)	doprobe=1 ;;
	-t)	popnew= ;;
	-i)	input=$2; shift
		set x ${1+"$@"} "" `cat $input`; shift
		;;
	--)	shift; break ;;
	-?*)	echo "$cmd: $1: unrecognised option" >&2
		badopts=1
		;;
	*)	break ;;
    esac
    shift
done

[ $badopts ] && { echo "$usage" >&2; exit 1; }

[ -n "$BROWSER_DISPLAY" ] || { echo "$cmd: no \$BROWSER_DISPLAY!" >&2; exit 1; }

if [ $anon ]; then anonpfx=http://anon.free.anonymizer.com/
              else anonpfx=
fi

if [ $# != 0 ]
then
    for url
    do
      case "$url" in
	-)	cat ;;
	xclip)	xclip -o | tr '\011' ' '; echo ;; # was cutbuffer
	*)	echo "$url" ;;
      esac
    done \
    | "$0" $subopts
    exit $?
fi

mrfn='
    mozremote()
    { for _mr_n in 1 2 3
      do '"$mozremote"' ${1+"$@"} && return 0
	 sleep 1
      done
      return 1
    }'
eval "$mrfn"

if [ "x$DISPLAY" = "x$BROWSER_DISPLAY" ]
then
    probe()
    { mozremote 'ping()'
    }

    # start browser if needed
    case "$BROWSER_DISPLAY" in
      :* | lo:* | localhost:* | 127.0.0.1:* | "$IPADDR:"* )
	: browser -q \
	|| { set-x bgproc -p - -- browser
	     echo "waiting for browser..."
	     while :
	     do  browser -q && break
		 necho .; sleep 1
	     done
	     while :
	     do  probe && break
		 necho .; sleep 1
	     done
	   }
	;;
    esac
else
    DISPLAY=$BROWSER_DISPLAY
    export DISPLAY
fi

cleanurllist \
| \
( exec 3>&1 1>&2
  printf "%s\n" "$mrfn" >&3
  while read url
  do  
    case "$url" in
      search\ *)
	metacmd=`expr "x$url" : 'x\([^ ]*\) .*'`
	url=`expr "x$url" : 'x[^ ]*  *\(.*\)'`
	case $metacmd in
	  search)
		engine=`expr "x$url" : 'x\([^ ]*\) .*'`
		url="http://web/~cameron/cgi-bin/search.cgi?engine=$engine&query="`expr "x$url" : 'x[^ ]*  *\(.*\)'`
		;;
	  *)	echo "$cmd: bogus meta command \"$metacmd\"" >&2
		;;
	esac
	;;
    esac
    [ $doclean ] && url="http://web/~cameron/cgi-bin/htclean.cgi/$url"
    [ $doanon  ] && url="http://anon.free.anonymizer.com/$url"

    # escape stuff for OpenURL() call
    url=`echo "$url" | hexify`
    [ -n "$URLLOG" ] && echo "urlshow $url" >>"$URLLOG"
    if [ $popnew ]
    then
      echo mozremote "'openurl($url,new-window)' || exit 1" >&3
      popnew=
    else
      ##echo usleep 200000 >&3
      echo mozremote "'openurl($url,new-tab)' || exit 1" >&3
    fi
  done \
) \
| catthen lock mozilla-xremote-client sh
